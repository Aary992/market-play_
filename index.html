<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>MarketPlay â€” Finance Learning Game</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#060608;--card:#0f0f13;--b1:rgba(255,255,255,.06);--b2:rgba(255,255,255,.1);
  --blue:#4F8EF7;--purple:#9D6EF8;--green:#0FD98A;--red:#F05252;--amber:#F5A623;
  --t1:#F2F0EE;--t2:#888;--t3:#404040;
  --ffd:'Syne',sans-serif;--ffm:'Space Mono',monospace;--ffb:'DM Sans',sans-serif;
}
html,body,#root{height:100%;background:var(--bg);color:var(--t1);font-family:var(--ffb);-webkit-font-smoothing:antialiased;touch-action:manipulation;overflow:hidden}
input{font-family:var(--ffb);outline:none;border:none}
::-webkit-scrollbar{width:2px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:1px}

@keyframes orb-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes orb-glow{0%,100%{box-shadow:0 0 14px rgba(79,142,247,.45),0 0 30px rgba(157,110,248,.16)}50%{box-shadow:0 0 26px rgba(79,142,247,.7),0 0 55px rgba(157,110,248,.32)}}
@keyframes ripple-out{from{transform:scale(.7);opacity:.7}to{transform:scale(3);opacity:0}}
@keyframes burst-p{0%{transform:translate(-50%,-50%) scale(1);opacity:.8}100%{transform:translate(calc(-50% + var(--bx)),calc(-50% + var(--by))) scale(0);opacity:0}}
@keyframes chart-draw{from{stroke-dashoffset:var(--dl,1400)}to{stroke-dashoffset:0}}
@keyframes ticker-scroll{from{transform:translateX(0)}to{transform:translateX(-50%)}}
@keyframes screen-in{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pop-in{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
@keyframes shake-card{0%,100%{transform:translateX(0)}20%{transform:translateX(-7px)}40%{transform:translateX(7px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
@keyframes xp-rise{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-24px)}}
@keyframes dot-pulse{0%,80%,100%{transform:scale(.6);opacity:.3}40%{transform:scale(1);opacity:1}}
@keyframes bubble-in{from{opacity:0;transform:translateY(6px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes bubble-out{from{opacity:1}to{opacity:0;transform:translateY(4px) scale(.96)}}
@keyframes scene-drop{from{opacity:0;transform:translateY(-20px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes node-ping{0%{transform:scale(1);opacity:1}100%{transform:scale(2.2);opacity:0}}
@keyframes insight-rise{from{opacity:0;transform:translateY(22px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes bar-grow{from{transform:scaleX(0)}to{transform:scaleX(1)}}
@keyframes sweep-green{from{opacity:0;transform:scaleX(0)}to{opacity:1;transform:scaleX(1)}}
@keyframes float-p{0%{transform:translateY(0) scale(1);opacity:.6}100%{transform:translateY(-60px) translateX(var(--px,0px)) scale(0);opacity:0}}
@keyframes slide-up-in{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes border-glow{0%,100%{opacity:.5}50%{opacity:1}}
@keyframes count-up{0%{transform:scale(.6);opacity:0}70%{transform:scale(1.15);opacity:1}100%{transform:scale(1);opacity:1}}
@keyframes flow-appear{from{opacity:0;transform:scale(.8) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes arrow-dash{from{stroke-dashoffset:40}to{stroke-dashoffset:0}}
@keyframes xp-burst{0%{opacity:1;transform:translateY(0) scale(.8)}55%{opacity:1;transform:translateY(-38px) scale(1.25)}100%{opacity:0;transform:translateY(-60px) scale(.9)}}
@keyframes flash-green{0%{opacity:0}20%{opacity:1}100%{opacity:0}}
@keyframes flash-red{0%{opacity:0}20%{opacity:1}100%{opacity:0}}
@keyframes option-in{from{opacity:0;transform:translateY(14px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes q-dramatic{from{opacity:0;transform:scale(.94) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes streak-fire{0%,100%{transform:scale(1) rotate(-2deg)}50%{transform:scale(1.12) rotate(2deg)}}
@keyframes ring-urgent{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}
@keyframes result-drop{from{opacity:0;transform:translateY(-30px) scale(.9)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes confetti-fall{0%{transform:translateY(-10px) rotate(0deg);opacity:1}100%{transform:translateY(60px) rotate(var(--r,180deg));opacity:0}}

.tap{cursor:pointer;-webkit-tap-highlight-color:transparent;transition:transform .12s cubic-bezier(.34,1.56,.64,1),opacity .1s ease;user-select:none}
.tap:active{transform:scale(.93);opacity:.78}
.btn-glow{position:relative;overflow:hidden}
.btn-glow::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateX(-100%) skewX(-15deg)}
.btn-glow:hover::after{transform:translateX(200%) skewX(-15deg);transition:transform .55s ease}

.game-shell{display:flex;flex-direction:column;width:100%;height:100vh;background:var(--bg);position:relative;overflow:hidden}
.game-sidebar{display:none}
.game-bottom-nav{display:flex}
@media(min-width:1024px){
  .game-shell{flex-direction:row}
  .game-sidebar{display:flex!important}
  .game-main{flex:1;border-left:1px solid var(--b1)}
  .game-bottom-nav{display:none!important}
  body{overflow:auto}
}
@media(min-width:640px) and (max-width:1023px){
  .game-shell{max-width:520px;margin:0 auto;box-shadow:0 0 80px rgba(79,142,247,.06)}
}


</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script type="text/babel" data-presets="react">
const {useState,useEffect,useRef,useCallback,useMemo,memo} = React;

// â”€â”€ SOUND ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SFX=(()=>{
  let ctx=null;
  const ac=()=>{if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)();return ctx};
  const tone=(freq,type='sine',vol=.18,start=0,dur=.12)=>{
    try{const c=ac(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type=type;o.frequency.setValueAtTime(freq,c.currentTime+start);g.gain.setValueAtTime(0,c.currentTime+start);g.gain.linearRampToValueAtTime(vol,c.currentTime+start+.01);g.gain.exponentialRampToValueAtTime(.0001,c.currentTime+start+dur);o.start(c.currentTime+start);o.stop(c.currentTime+start+dur+.05)}catch(_){}
  };
  return{
    tap:()=>tone(880,'sine',.06,0,.06),
    correct:()=>{[523,659,784].forEach((f,i)=>tone(f,'sine',.13,i*.015,.28));tone(1047,'sine',.09,.12,.18)},
    wrong:()=>{tone(220,'sawtooth',.12,0,.06);tone(196,'sawtooth',.1,.04,.1)},
    step:()=>tone(660,'sine',.08,0,.1),
    tick:()=>tone(1200,'sine',.04,0,.04),
    tickUrgent:()=>{tone(1400,'square',.06,0,.04);tone(1400,'square',.04,.06,.04)},
    complete:()=>{[523,659,784,1047,1319].forEach((f,i)=>tone(f,'sine',.13,i*.09,.25));tone(1568,'sine',.1,.55,.35)},
    allocate:()=>tone(740,'sine',.07,0,.08),
  };
})();

const vib=p=>navigator?.vibrate?.(p);
const H={light:()=>vib(6),medium:()=>vib(18),success:()=>vib([6,38,10]),error:()=>vib([15,26,15])};

// â”€â”€ LEVELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LEVELS=[
  {name:'Observer',  min:0,   color:'#666',    icon:'ðŸ‘ï¸'},
  {name:'Analyst',   min:150, color:'#4F8EF7', icon:'ðŸ“Š'},
  {name:'Strategist',min:400, color:'#9D6EF8', icon:'âš¡'},
  {name:'Architect', min:800, color:'#0FD98A', icon:'ðŸ›ï¸'},
  {name:'Macro Mind',min:1500,color:'#F5A623', icon:'ðŸŒ'},
];
const getLevel=xp=>{for(let i=LEVELS.length-1;i>=0;i--)if(xp>=LEVELS[i].min)return{...LEVELS[i],idx:i};return{...LEVELS[0],idx:0}};
const CUES={
  correct:['You saw that.','Clean read.','That instinct is improving.','Exactly right.','Most people miss that.'],
  wrong:['Look again.','Think about who benefits.','Context changes everything.','You hesitated.'],
  start:['Ready to sharpen your edge?',"Let's see what you've got.",'Welcome back.'],
  trade:['Allocate with intent.','Every position is a thesis.','The clock is live.'],
  hook:['One more confirms it.','Your pattern recognition is building.','Keep going.'],
};
const cue=k=>{const a=CUES[k]||CUES.start;return a[Math.floor(Math.random()*a.length)]};

// â”€â”€ QUESTION BANK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ALL_Q=[
  {tier:1,cat:'ðŸ’¼ Business',q:"What does it mean for a company to make a 'profit'?",opts:['Revenue minus all costs equals profit','Total money the company receives','Money paid to employees','Loans taken from the bank'],ans:0,explain:'Profit = Revenue âˆ’ Costs. A coffee shop earning Â£1,000 and spending Â£700 makes Â£300 profit.',visual:{type:'formula',parts:[{label:'Revenue',value:'Â£1,000',color:'#0FD98A'},{op:'âˆ’'},{label:'Costs',value:'Â£700',color:'#F05252'},{op:'='},{label:'Profit',value:'Â£300',color:'#4F8EF7'}]}},
  {tier:1,cat:'ðŸ’¼ Business',q:"What is 'revenue'?",opts:['The profit after expenses','The total money a business earns from sales','The money left in the bank','The amount owed to suppliers'],ans:1,explain:'Revenue is the top line â€” all money coming in before any costs are subtracted.',visual:{type:'flow',steps:[{icon:'ðŸ›ï¸',label:'Customer buys',color:'#4F8EF7'},{icon:'ðŸ’°',label:'Payment received',color:'#9D6EF8'},{icon:'ðŸ“Š',label:'Revenue recorded',color:'#0FD98A'}]}},
  {tier:1,cat:'ðŸ’¼ Business',q:'A shop earns Â£500 but spent Â£600 on stock and rent. What happened?',opts:['It made a Â£100 profit','It broke even','It made a Â£100 loss','It made a Â£1,100 profit'],ans:2,explain:'Â£500 in, Â£600 out = Â£100 loss. Spending more than you earn is operating at a loss.',visual:{type:'bar',bars:[{label:'Income',value:500,max:700,color:'#0FD98A',prefix:'Â£'},{label:'Expenses',value:600,max:700,color:'#F05252',prefix:'Â£'}]}},
  {tier:1,cat:'ðŸ“ˆ Investing',q:"What is a 'stock' (also called a share)?",opts:['A loan you give to a company','A small piece of ownership in a company','A government savings certificate','A monthly payment from a bank'],ans:1,explain:'Owning 1 share of Apple means you own a tiny slice of Apple. If Apple grows, your slice is worth more.',visual:{type:'donut',center:'ðŸ¢',segments:[{label:'Public shares',value:70,color:'#4F8EF7'},{label:'Founders',value:20,color:'#9D6EF8'},{label:'Your share',value:10,color:'#0FD98A'}]}},
  {tier:1,cat:'ðŸ’° Finance',q:'You borrow Â£1,000 at 10% interest per year. How much do you owe after one year?',opts:['Â£1,000','Â£1,010','Â£1,100','Â£1,200'],ans:2,explain:'10% of Â£1,000 = Â£100 interest. You pay back Â£1,000 + Â£100 = Â£1,100.',visual:{type:'formula',parts:[{label:'Borrowed',value:'Â£1,000',color:'#4F8EF7'},{op:'+'},{label:'Interest 10%',value:'Â£100',color:'#F5A623'},{op:'='},{label:'You owe',value:'Â£1,100',color:'#F05252'}]}},
  {tier:1,cat:'ðŸ¦ Economics',q:"What is 'inflation' in simple terms?",opts:['When the economy grows fast','When prices of everyday goods rise over time',"When a stock's price increases",'When the government cuts taxes'],ans:1,explain:"Inflation means your money buys less over time. Coffee at Â£2.00 today, Â£2.10 next year = 5% inflation.",visual:{type:'stat',items:[{icon:'â˜•',label:'Coffee today',value:'Â£2.00',color:'#0FD98A'},{icon:'ðŸ“…',label:'Coffee next year',value:'Â£2.10',color:'#F05252'},{icon:'ðŸ“ˆ',label:'Inflation rate',value:'+5%',color:'#F5A623'}]}},
  {tier:1,cat:'ðŸ’¼ Business',q:'What does a CEO do?',opts:["Designs the company's products",'Manages day-to-day accounting','Leads the company and makes major decisions','Approves employee salaries one by one'],ans:2,explain:'CEO = Chief Executive Officer. They set strategy and direction â€” the captain of the ship.',visual:{type:'flow',steps:[{icon:'ðŸ›ï¸',label:'Board of Directors',color:'#9D6EF8'},{icon:'ðŸ‘¤',label:'CEO sets strategy',color:'#4F8EF7'},{icon:'ðŸ­',label:'Teams execute',color:'#0FD98A'}]}},
  {tier:1,cat:'ðŸ’° Finance',q:"What's the difference between a debit card and a credit card?",opts:['They work the same way','Debit uses your own money; credit borrows from the bank','Credit uses your own money; debit borrows','Debit cards have higher spending limits'],ans:1,explain:'Debit pulls from your bank account. Credit is a short-term loan from the bank you repay later.',visual:{type:'compare',left:{label:'Debit Card',color:'#0FD98A',icon:'ðŸ’³',points:['Your own money','Instant deduction','No debt created','Spend what you have']},right:{label:'Credit Card',color:'#F05252',icon:'ðŸ’³',points:['Bank loan','Pay back later','Interest if late','Can overspend']}}},
  {tier:2,cat:'ðŸ“ˆ Investing',q:"What does it mean to 'diversify' your investments?",opts:['Put all money in the best-performing stock','Spread money across different investments to reduce risk','Only invest in safe government bonds','Sell everything when prices fall'],ans:1,explain:"Don't put all eggs in one basket. If you own stocks, bonds, and property, a crash in one doesn't wipe you out.",visual:{type:'donut',center:'ðŸ“Š',segments:[{label:'Stocks',value:40,color:'#4F8EF7'},{label:'Bonds',value:25,color:'#9D6EF8'},{label:'Property',value:20,color:'#0FD98A'},{label:'Cash',value:15,color:'#F5A623'}]}},
  {tier:2,cat:'ðŸ“ˆ Investing',q:"A company pays a 'dividend'. What is that?",opts:['A penalty for poor performance','A share of profits paid to shareholders','A tax on company earnings','A loan from investors'],ans:1,explain:"Dividends reward shareholders with cash from profits. McDonald's pays one every quarter.",visual:{type:'flow',steps:[{icon:'ðŸ“Š',label:'Company earns profit',color:'#0FD98A'},{icon:'ðŸ’¸',label:'Dividend declared',color:'#4F8EF7'},{icon:'ðŸ‘¥',label:'Paid to shareholders',color:'#9D6EF8'}]}},
  {tier:2,cat:'ðŸ“Š Markets',q:'When demand is high but supply is low, what usually happens to the price?',opts:['Price falls','Price stays the same','Price rises','Government fixes the price'],ans:2,explain:'Classic supply and demand. Concert tickets sell out â†’ touts charge Â£300 for a Â£50 ticket.',visual:{type:'chart',points:[50,48,50,55,62,72,85,95,100],label:'Price rises when supply drops',color:'#F05252'}},
  {tier:2,cat:'ðŸ’¼ Business',q:'A startup raises money from investors by giving them shares. What does this mean for founders?',opts:['They get free money they never repay','They give up a percentage of ownership in exchange for cash','They take on debt that must be repaid','They hand over full control of the company'],ans:1,explain:'Equity fundraising = selling ownership. Investors own a slice; founders own less but now have cash to grow.',visual:{type:'donut',center:'ðŸš€',segments:[{label:'Founders 80%',value:80,color:'#4F8EF7'},{label:'Investor 20%',value:20,color:'#9D6EF8'}]}},
  {tier:2,cat:'ðŸ’° Finance',q:"You have Â£5,000 in credit card debt at 20% annual interest. What happens if you don't pay for a year?",opts:['You owe exactly Â£5,000','You owe Â£5,100','You owe Â£6,000','You owe Â£5,200'],ans:2,explain:'20% of Â£5,000 = Â£1,000 interest. Total = Â£6,000. High-interest debt compounds fast.',visual:{type:'formula',parts:[{label:'Debt',value:'Â£5,000',color:'#F05252'},{op:'+'},{label:'20% interest',value:'Â£1,000',color:'#F5A623'},{op:'='},{label:'Total owed',value:'Â£6,000',color:'#F05252'}]}},
  {tier:2,cat:'ðŸ“Š Markets',q:"What is a 'bull market'?",opts:['Prices are falling overall','Prices are rising overall','A market that only trades commodities','Trading sessions that start at dawn'],ans:1,explain:'Bull = charging upward. Bear = falling. Bull markets are periods of optimism and rising stock prices.',visual:{type:'chart',points:[40,42,45,43,48,52,58,65,72,80],label:'Bull market â€” sustained upward trend',color:'#0FD98A'}},
  {tier:2,cat:'ðŸ¦ Economics',q:"What does a central bank (like the Bank of England) do?",opts:['Lends money directly to individuals',"Controls interest rates and manages a country's money supply",'Invests in the stock market for the government','Collects taxes on behalf of the government'],ans:1,explain:"The Bank of England sets base interest rates and ensures financial stability.",visual:{type:'stat',items:[{icon:'ðŸ¦',label:'Sets base rate',value:'5.25%',color:'#4F8EF7'},{icon:'ðŸ’¸',label:'Controls money supply',value:'QE',color:'#9D6EF8'},{icon:'ðŸ“Š',label:'Target inflation',value:'2%',color:'#0FD98A'}]}},
  {tier:3,cat:'ðŸ¦ Economics',q:"The Bank of England raises rates from 4% to 5.5%. What's the most likely effect?",opts:['More people borrow because returns are higher','Fewer people borrow because monthly repayments increase','Nothing changes','Only big companies are affected'],ans:1,explain:'Higher rates = higher monthly payments on mortgages and loans. Fewer households and businesses want to borrow.',visual:{type:'bar',title:'Monthly mortgage on Â£200k',bars:[{label:'Rate: 4%',value:954,max:1200,color:'#0FD98A',prefix:'Â£'},{label:'Rate: 5.5%',value:1135,max:1200,color:'#F05252',prefix:'Â£'}]}},
  {tier:3,cat:'ðŸ’¼ Business',q:'A startup is valued at Â£10 million. An investor pays Â£2 million. What percentage do they own?',opts:['10%','20%','25%','50%'],ans:1,explain:'Â£2M Ã· Â£10M = 20%. The investor now owns a fifth of the company.',visual:{type:'donut',center:'20%',segments:[{label:'Founders 80%',value:80,color:'#4F8EF7'},{label:'Investor 20%',value:20,color:'#9D6EF8'}]}},
  {tier:3,cat:'ðŸ’¼ Business',q:"What does a company's 'balance sheet' show?",opts:['Monthly sales and costs','What the company owns vs what it owes','The share price over time','How much the CEO earns'],ans:1,explain:'Assets âˆ’ Liabilities = Net Worth. A healthy company has more assets than liabilities.',visual:{type:'compare',left:{label:'Assets (owns)',color:'#0FD98A',icon:'ðŸ“¦',points:['Cash in bank','Equipment','Property','Receivables']},right:{label:'Liabilities (owes)',color:'#F05252',icon:'ðŸ’³',points:['Bank loans','Supplier debt','Bonds issued','Tax owed']}}},
  {tier:3,cat:'ðŸ“ˆ Investing',q:'A bond is different from a stock because:',opts:['Bonds give you ownership in a company','Bonds are a loan you give that pays fixed interest','Bonds are riskier than stocks','Bonds never lose value'],ans:1,explain:'Buy a bond = lend money. They pay you interest (a coupon) and return your money at the end.',visual:{type:'compare',left:{label:'Stock',color:'#4F8EF7',icon:'ðŸ“ˆ',points:['Ownership','Variable returns','Higher risk','Dividends possible']},right:{label:'Bond',color:'#9D6EF8',icon:'ðŸ“„',points:['Loan to company','Fixed interest','Lower risk','Money returned at end']}}},
  {tier:3,cat:'ðŸ’° Finance',q:'You invest Â£1,000 at 10% per year. After 3 years compounding, how much do you have?',opts:['Â£1,100','Â£1,300','Â£1,331','Â£1,400'],ans:2,explain:'Year 1: Â£1,100. Year 2: Â£1,210. Year 3: Â£1,331. Compound interest â€” you earn returns on your returns.',visual:{type:'chart',points:[1000,1100,1210,1331],label:'Compound growth on Â£1,000',color:'#0FD98A'}},
  {tier:3,cat:'ðŸ¦ Economics',q:"What causes a country's currency to weaken?",opts:['High interest rates','Strong economic growth','High inflation and low interest rates','Low government debt'],ans:2,explain:'High inflation = currency buys less. Low rates = low returns. Foreign investors leave â†’ currency weakens.',visual:{type:'flow',steps:[{icon:'ðŸ”¥',label:'Inflation rises',color:'#F05252'},{icon:'ðŸ“‰',label:'Low interest rates',color:'#F5A623'},{icon:'âœˆï¸',label:'Investors leave',color:'#9D6EF8'},{icon:'ðŸ’±',label:'Currency weakens',color:'#F05252'}]}},
  {tier:4,cat:'ðŸ’¼ Business',q:"Revenue Â£500K, costs Â£200K, operating expenses Â£150K. What's the operating profit?",opts:['Â£150,000','Â£300,000','Â£350,000','Â£500,000'],ans:0,explain:'500K âˆ’ 200K âˆ’ 150K = Â£150K operating profit.',visual:{type:'bar',title:'P&L Breakdown',bars:[{label:'Revenue',value:500,max:500,color:'#0FD98A',prefix:'Â£',suffix:'K'},{label:'Cost of Goods',value:200,max:500,color:'#F05252',prefix:'Â£',suffix:'K'},{label:'Op. Expenses',value:150,max:500,color:'#F5A623',prefix:'Â£',suffix:'K'},{label:'Op. Profit',value:150,max:500,color:'#4F8EF7',prefix:'Â£',suffix:'K'}]}},
  {tier:4,cat:'ðŸ“Š Markets',q:"A company beats earnings by 8%. The stock drops 6% next morning. Why?",opts:['Investors expected even better results','The company committed fraud','The broader market crashed','Analysts downgraded the stock'],ans:0,explain:'Prices reflect expectations. If the market expected +15% and got +8%, that gap is a miss even though the number looks good.',visual:{type:'stat',items:[{icon:'ðŸŽ¯',label:'Market expected',value:'+15%',color:'#0FD98A'},{icon:'ðŸ“Š',label:'Company delivered',value:'+8%',color:'#F5A623'},{icon:'ðŸ“‰',label:'Expectation gap',value:'âˆ’7%',color:'#F05252'}]}},
  {tier:4,cat:'ðŸ“ˆ Investing',q:'Why might a company issue bonds instead of new shares to raise money?',opts:['Bonds give investors voting rights',"Bonds don't dilute existing shareholders",'Bonds are always cheaper',"Bonds don't need to be repaid"],ans:1,explain:'New shares = more owners = each share worth less (dilution). Bonds are debt â€” ownership stays the same.',visual:{type:'compare',left:{label:'Issue Shares',color:'#F05252',icon:'ðŸ“‰',points:['Raises cash','Dilutes owners','Each share worth less','No repayment']},right:{label:'Issue Bonds',color:'#0FD98A',icon:'ðŸ“„',points:['Raises cash','Ownership preserved','Fixed interest cost','Must repay at maturity']}}},
  {tier:4,cat:'ðŸ¦ Economics',q:"Oil spikes 40% while inflation is already at 6%. Why does this trap the central bank?",opts:['Must raise and cut rates simultaneously','Raising rates fights inflation but hurts a slowing economy','Central banks cannot act during supply shocks','Higher oil reduces the need for rate hikes'],ans:1,explain:'Stagflation: supply shocks raise prices AND slow growth. Raise rates â†’ fight inflation but cause more pain.',visual:{type:'flow',steps:[{icon:'ðŸ›¢ï¸',label:'Oil spike +40%',color:'#F5A623'},{icon:'ðŸ”¥',label:'Inflation â†’ 9%',color:'#F05252'},{icon:'ðŸ¤”',label:'Raise rates = recession?',color:'#9D6EF8'},{icon:'âš ï¸',label:'Stagflation trap',color:'#F05252'}]}},
  {tier:5,cat:'ðŸ“Š Markets',q:"A company's P/E is 40 vs industry average of 20. What does this suggest?",opts:['The company is cheap compared to peers','Investors expect higher growth and pay a premium','The company makes twice the profit of competitors','The company should reduce its share price'],ans:1,explain:"P/E = price Ã· earnings. A high P/E means investors believe future earnings will be much higher.",visual:{type:'bar',title:'P/E Ratio Comparison',bars:[{label:'Industry avg',value:20,max:45,color:'#888'},{label:'This company',value:40,max:45,color:'#4F8EF7'}]}},
  {tier:5,cat:'ðŸ¦ Economics',q:'Why can high inflation benefit someone who borrowed at a fixed rate?',opts:["It doesn't â€” inflation always hurts borrowers",'They repay the same amount in money worth less in real terms','Their monthly payments automatically shrink','The bank forgives part of the debt'],ans:1,explain:"Borrowed Â£100K at 3% fixed, inflation hits 8%, your salary rises but repayments don't. You repay cheaper money.",visual:{type:'stat',items:[{icon:'ðŸ ',label:'Fixed payment',value:'Â£500 (unchanged)',color:'#4F8EF7'},{icon:'ðŸ’°',label:'Salary grows',value:'Â£40k â†’ Â£43.2k',color:'#0FD98A'},{icon:'ðŸ“‰',label:'Real cost of debt',value:'Getting smaller',color:'#F5A623'}]}},
  {tier:5,cat:'ðŸ“ˆ Investing',q:'A strong US dollar hurts US companies that earn overseas. Why?',opts:['Foreign customers pay more so revenue rises','Overseas revenue converts to fewer dollars when brought home','A strong dollar reduces production costs','It prevents international expansion'],ans:1,explain:'Earn â‚¬10M, dollar strengthens 15%, those euros convert to fewer dollars. Revenue fine abroad but shrinks in the annual report.',visual:{type:'flow',steps:[{icon:'ðŸ‡ªðŸ‡º',label:'Earn â‚¬10M in Europe',color:'#4F8EF7'},{icon:'ðŸ’ª',label:'Dollar strengthens +15%',color:'#F5A623'},{icon:'ðŸ’±',label:'Converts to fewer $',color:'#F05252'},{icon:'ðŸ“‰',label:'US revenue shrinks',color:'#F05252'}]}},
];

const pickQ=(sessionCount,count=5)=>{
  const tier=Math.min(5,1+Math.floor(sessionCount/2));
  const pool=ALL_Q.filter(q=>q.tier<=tier);
  return [...pool].sort(()=>Math.random()-.5).slice(0,count);
};

// â”€â”€ VISUAL COMPONENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function FormulaVisual({data}){
  return(
    <div style={{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap',justifyContent:'center',padding:'12px 0'}}>
      {data.parts.map((p,i)=>p.op
        ?<span key={i} style={{fontFamily:'var(--ffm)',fontSize:18,color:'var(--t2)',fontWeight:700}}>{p.op}</span>
        :<div key={i} style={{padding:'8px 14px',borderRadius:10,background:`${p.color}15`,border:`1px solid ${p.color}35`,textAlign:'center',minWidth:72,animation:`count-up .4s cubic-bezier(.34,1.56,.64,1) ${i*80}ms both`}}>
          <div style={{fontFamily:'var(--ffd)',fontSize:18,fontWeight:800,color:p.color}}>{p.value}</div>
          <div style={{fontFamily:'var(--ffm)',fontSize:8.5,color:'var(--t3)',marginTop:2,letterSpacing:'.06em'}}>{p.label.toUpperCase()}</div>
        </div>
      )}
    </div>
  );
}

function BarVisual({data}){
  return(
    <div style={{padding:'8px 0'}}>
      {data.title&&<div style={{fontFamily:'var(--ffm)',fontSize:9,color:'var(--t3)',letterSpacing:'.1em',marginBottom:8}}>{data.title.toUpperCase()}</div>}
      <div style={{display:'flex',flexDirection:'column',gap:7}}>
        {data.bars.map((b,i)=>(
          <div key={i} style={{display:'flex',alignItems:'center',gap:9}}>
            <div style={{width:80,fontSize:11,color:'var(--t2)',textAlign:'right',flexShrink:0}}>{b.label}</div>
            <div style={{flex:1,height:22,background:'rgba(255,255,255,.05)',borderRadius:5,overflow:'hidden'}}>
              <div style={{height:'100%',width:`${(b.value/b.max)*100}%`,background:b.color,borderRadius:5,animation:`bar-grow .6s cubic-bezier(.34,1.56,.64,1) ${i*100}ms both`,transformOrigin:'left',boxShadow:`0 0 8px ${b.color}40`}}/>
            </div>
            <div style={{fontFamily:'var(--ffm)',fontSize:11,fontWeight:700,color:b.color,minWidth:48,flexShrink:0}}>{b.prefix||''}{b.value}{b.suffix||''}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

function StatVisual({data}){
  return(
    <div style={{display:'grid',gridTemplateColumns:`repeat(${Math.min(data.items.length,3)},1fr)`,gap:8,padding:'6px 0'}}>
      {data.items.map((item,i)=>(
        <div key={i} style={{padding:'10px 8px',borderRadius:11,textAlign:'center',background:`${item.color||'#4F8EF7'}0f`,border:`1px solid ${item.color||'#4F8EF7'}25`,animation:`count-up .45s cubic-bezier(.34,1.56,.64,1) ${i*90}ms both`}}>
          <div style={{fontSize:20,marginBottom:4}}>{item.icon}</div>
          <div style={{fontFamily:'var(--ffd)',fontSize:12,fontWeight:800,color:item.color||'#4F8EF7',lineHeight:1.2}}>{item.value}</div>
          <div style={{fontFamily:'var(--ffm)',fontSize:8,color:'var(--t3)',marginTop:4,letterSpacing:'.05em'}}>{item.label.toUpperCase()}</div>
        </div>
      ))}
    </div>
  );
}

function CompareVisual({data}){
  return(
    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,padding:'6px 0'}}>
      {[data.left,data.right].map((side,si)=>(
        <div key={si} style={{padding:'10px 11px',borderRadius:11,background:`${side.color}0c`,border:`1px solid ${side.color}28`,animation:`flow-appear .4s ease ${si*100}ms both`}}>
          <div style={{display:'flex',alignItems:'center',gap:5,marginBottom:8}}>
            <span style={{fontSize:14}}>{side.icon}</span>
            <span style={{fontFamily:'var(--ffd)',fontSize:11,fontWeight:800,color:side.color}}>{side.label}</span>
          </div>
          {side.points.map((pt,i)=>(
            <div key={i} style={{display:'flex',alignItems:'flex-start',gap:5,marginBottom:4}}>
              <span style={{fontSize:8,color:side.color,marginTop:3,flexShrink:0}}>â–¸</span>
              <span style={{fontSize:10.5,color:'var(--t2)',lineHeight:1.4}}>{pt}</span>
            </div>
          ))}
        </div>
      ))}
    </div>
  );
}

function ChartVisual({data}){
  const W=280,H=56,pad=5;
  const mn=Math.min(...data.points),mx=Math.max(...data.points),rng=mx-mn||1;
  const pts=data.points.map((v,i)=>[(i/(data.points.length-1))*W,H-((v-mn)/rng)*(H-pad*2)-pad]);
  const line=pts.map((p,i)=>`${i?'L':'M'} ${p[0].toFixed(1)} ${p[1].toFixed(1)}`).join(' ');
  const dl=pts.reduce((acc,p,i)=>i?acc+Math.hypot(p[0]-pts[i-1][0],p[1]-pts[i-1][1]):0,0)+20;
  const uid=`cv${Math.random().toString(36).slice(2)}`;
  return(
    <div style={{padding:'8px 0'}}>
      <svg viewBox={`0 0 ${W} ${H}`} style={{width:'100%',height:H,display:'block'}}>
        <defs><linearGradient id={uid} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={data.color} stopOpacity=".22"/><stop offset="100%" stopColor={data.color} stopOpacity="0"/></linearGradient></defs>
        <path d={`${line} L ${W} ${H} L 0 ${H} Z`} fill={`url(#${uid})`}/>
        <path d={line} fill="none" stroke={data.color} strokeWidth="2.2" strokeLinecap="round" style={{strokeDasharray:dl,strokeDashoffset:dl,animation:'chart-draw 1s ease forwards'}}/>
        <circle cx={pts[pts.length-1][0]} cy={pts[pts.length-1][1]} r="3" fill={data.color} style={{filter:`drop-shadow(0 0 4px ${data.color}90)`}}/>
      </svg>
      <div style={{fontFamily:'var(--ffm)',fontSize:9,color:'var(--t3)',textAlign:'center',marginTop:4,letterSpacing:'.06em'}}>{data.label.toUpperCase()}</div>
    </div>
  );
}

function DonutVisual({data}){
  const r=38,c=2*Math.PI*r,total=data.segments.reduce((a,b)=>a+b.value,0);
  let offset=0;
  return(
    <div style={{display:'flex',alignItems:'center',gap:14,padding:'6px 0'}}>
      <svg viewBox="0 0 90 90" style={{width:90,height:90,flexShrink:0,transform:'rotate(-90deg)'}}>
        {data.segments.map((seg,i)=>{
          const dash=(seg.value/total)*c;
          const el=<circle key={i} cx="45" cy="45" r={r} fill="none" stroke={seg.color} strokeWidth="13" strokeLinecap="butt" strokeDasharray={`${dash-1.5} ${c-dash+1.5}`} strokeDashoffset={-offset} style={{filter:`drop-shadow(0 0 4px ${seg.color}60)`}}/>;
          offset+=dash;return el;
        })}
        {data.center&&<text x="45" y="49" textAnchor="middle" dominantBaseline="middle" fontSize="16" fill="white" style={{transform:'rotate(90deg)',transformOrigin:'45px 45px'}}>{data.center}</text>}
      </svg>
      <div style={{display:'flex',flexDirection:'column',gap:5}}>
        {data.segments.map((seg,i)=>(
          <div key={i} style={{display:'flex',alignItems:'center',gap:6}}>
            <div style={{width:8,height:8,borderRadius:2,background:seg.color,flexShrink:0}}/>
            <span style={{fontSize:11,color:'var(--t2)'}}>{seg.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

function FlowVisual({data}){
  return(
    <div style={{display:'flex',alignItems:'center',padding:'8px 0',flexWrap:'wrap',justifyContent:'center'}}>
      {data.steps.map((step,i)=>(
        <div key={i} style={{display:'flex',alignItems:'center'}}>
          <div style={{padding:'8px 10px',borderRadius:10,textAlign:'center',minWidth:62,background:`${step.color||'#4F8EF7'}12`,border:`1px solid ${step.color||'#4F8EF7'}28`,animation:`flow-appear .4s cubic-bezier(.34,1.56,.64,1) ${i*110}ms both`}}>
            <div style={{fontSize:18}}>{step.icon}</div>
            <div style={{fontSize:9.5,color:'var(--t1)',marginTop:3,fontWeight:600,lineHeight:1.3}}>{step.label}</div>
          </div>
          {i<data.steps.length-1&&<svg width="20" height="16" viewBox="0 0 20 16" style={{flexShrink:0}}><path d="M2 8 L14 8 M10 4 L14 8 L10 12" stroke="rgba(255,255,255,.2)" strokeWidth="1.5" fill="none" strokeLinecap="round" style={{strokeDasharray:40,strokeDashoffset:40,animation:`arrow-dash .4s ease ${i*110+200}ms forwards`}}/></svg>}
        </div>
      ))}
    </div>
  );
}

function QuestionVisual({visual}){
  return(
    <div style={{background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:14,padding:'12px 14px',marginBottom:14}}>
      {visual.type==='formula'&&<FormulaVisual data={visual}/>}
      {visual.type==='bar'&&<BarVisual data={visual}/>}
      {visual.type==='stat'&&<StatVisual data={visual}/>}
      {visual.type==='compare'&&<CompareVisual data={visual}/>}
      {visual.type==='chart'&&<ChartVisual data={visual}/>}
      {visual.type==='donut'&&<DonutVisual data={visual}/>}
      {visual.type==='flow'&&<FlowVisual data={visual}/>}
    </div>
  );
}

// â”€â”€ TRADING ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TEMPLATES=[
  {headlines:['âš¡ Armed conflict disrupts major oil corridor','ðŸ›¢ï¸ Strait of Hormuz partially blocked'],subs:['Markets pricing in sustained supply disruption','Safe-haven inflows accelerate'],color:'#F05252',bias:{gold:1,oil:1,tech:-1,bonds:1,btc:-1}},
  {headlines:['ðŸ“‰ Fed cuts 75bps â€” largest in 4 years','ðŸ¦ ECB emergency cut: rates fall to 1.25%'],subs:['Growth assets rally','Dollar weakens'],color:'#4F8EF7',bias:{gold:1,bonds:1,tech:1,banks:-1,btc:1}},
  {headlines:['ðŸ“Š CPI hits 9.4% â€” 40-year record','ðŸ”¥ Producer prices surge 11%'],subs:['Rate hike expectations jump','Growth stocks under pressure'],color:'#F5A623',bias:{gold:1,oil:1,tech:-1,bonds:-1,btc:-1}},
  {headlines:['ðŸ“‰ GDP contracts 2.1% â€” recession confirmed','ðŸ­ Manufacturing PMI collapses to 41.2'],subs:['Credit conditions tighten','Risk appetite craters'],color:'#9D6EF8',bias:{gold:1,bonds:1,tech:-1,banks:-1,btc:-1}},
];
const ASSET_POOL=[
  {id:'gold',n:'Gold',icon:'ðŸ¥‡',hint:'Safe haven in uncertainty'},
  {id:'oil',n:'Oil',icon:'ðŸ›¢ï¸',hint:'Supply-sensitive commodity'},
  {id:'tech',n:'Tech Stocks',icon:'ðŸ’»',hint:'High-growth, rate-sensitive'},
  {id:'bonds',n:'US Bonds',icon:'ðŸ“„',hint:'Flight-to-safety asset'},
  {id:'btc',n:'Bitcoin',icon:'â‚¿',hint:'High-volatility risk asset'},
  {id:'banks',n:'Banks',icon:'ðŸ¦',hint:'Rate and credit sensitive'},
];
const generateSession=()=>{
  const t=TEMPLATES[Math.floor(Math.random()*TEMPLATES.length)];
  const hi=Math.floor(Math.random()*t.headlines.length);
  const b=t.bias;
  const relevant=ASSET_POOL.filter(a=>b[a.id]!==undefined);
  const extras=ASSET_POOL.filter(a=>b[a.id]===undefined);
  const assets=[...relevant,...extras].slice(0,5).map(a=>({...a,expected:b[a.id]??(Math.random()>.5?1:-1),vol:.35+Math.random()*.75}));
  return{headline:t.headlines[hi],sub:t.subs[hi%t.subs.length],color:t.color,assets};
};
const pricePath=(n=14,dir=0,vol=.5,seed=Math.random())=>{
  let price=50,momentum=0;
  return Array.from({length:n},(_,i)=>{
    const noise=(Math.sin(seed*137.5*(i+1))+Math.cos(seed*91.3*(i+1)))*vol*3.2;
    const trend=dir*(1.6+vol*1.8)*((i+1)/n);
    momentum=momentum*.55+(noise+trend)*.45;
    price=Math.max(8,Math.min(92,price+momentum));
    return +price.toFixed(2);
  });
};

// â”€â”€ LESSON DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LESSON=[
  {id:'hook',type:'choice',headline:'Record profits. Stock crashes.',body:'Company X reports its best quarter ever â€” revenue +22%, profit +18%. The stock falls 9% the next morning.',q:"What's the most likely explanation?",opts:[{id:'a',l:'The broader market had a bad day'},{id:'b',l:'Analysts had expected even stronger results'},{id:'c',l:'The company cut its dividend'},{id:'d',l:'Management sold shares before the report'}],ans:'b',explain:'Markets price expectations. The street expected +30%, got +18% â€” that gap is what matters, not the raw number.',cueKey:'start'},
  {id:'gap',type:'reveal',headline:'The Expectation Gap.',insight:"Prices move on the difference between what happened and what the market expected â€” not the raw outcome. A stock can fall on great news, and rise on bad news.",cueKey:'hook'},
  {id:'alloc',type:'allocate',headline:'Conflict erupts in a key oil region.',body:'Supply routes disrupted. Uncertainty spikes. Allocate your 100% across 4 assets.',cueKey:'start',assets:[{id:'gold',n:'Gold',icon:'ðŸ¥‡',hint:'Safe haven â€” surges in crises'},{id:'tech',n:'Tech',icon:'ðŸ’»',hint:'Risk-off kills growth stocks'},{id:'bonds',n:'US Bonds',icon:'ðŸ“„',hint:'Flight-to-safety default'},{id:'oil',n:'Oil',icon:'ðŸ›¢ï¸',hint:'Supply shock = price spike'}]},
  {id:'twist',type:'reveal',headline:'Ceasefire. Three days later.',body:'Oil falls 14%. Gold and bonds sell off. Tech surges as risk appetite snaps back.',insight:"Safe havens are priced on fear. When certainty returns, money rotates fast into higher-growth assets.",cueKey:'hook'},
  {id:'rates',type:'choice',headline:'Surprise rate hike: +0.75%.',body:'The Fed doubles what markets expected.',q:'Which asset suffers most from a surprise rate hike?',opts:[{id:'a',l:'Gold â€” investors prefer yield-bearing assets now'},{id:'b',l:'Long-term bonds â€” their fixed rates become uncompetitive'},{id:'c',l:'Cash â€” inflation erodes its value'},{id:'d',l:'Commodities â€” stronger dollar crushes prices'}],ans:'b',explain:'Long-term bonds reprice mechanically â€” their fixed future payments are immediately worth less when new bonds yield more.',cueKey:'hook'},
  {id:'insight',type:'insight',headline:'Three rules. Every market.',rules:[{icon:'ðŸ“Š',rule:'Surprise drives prices, not news.',sub:'The gap between expectation and outcome is what moves markets.'},{icon:'ðŸ”„',rule:"Risk rotates. It doesn't disappear.",sub:'Capital shifts between safe havens and growth assets as sentiment changes.'},{icon:'â³',rule:'Duration amplifies rate sensitivity.',sub:'Longer-dated assets feel rate changes far more than short-term ones.'}],cueKey:'hook'},
];

// â”€â”€ SHARED UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TICKS=[{s:'BTC',v:'+4.2%',u:1},{s:'GOLD',v:'+1.8%',u:1},{s:'OIL',v:'-2.1%',u:0},{s:'S&P',v:'+0.9%',u:1},{s:'BONDS',v:'-0.5%',u:0},{s:'TECH',v:'+3.1%',u:1},{s:'EUR',v:'-0.2%',u:0},{s:'SILVER',v:'+2.3%',u:1}];

const Ticker=memo(()=>(
  <div style={{overflow:'hidden',borderBottom:'1px solid var(--b1)',background:'rgba(6,6,6,.88)',padding:'5px 0',flexShrink:0}}>
    <div style={{display:'inline-flex',animation:'ticker-scroll 20s linear infinite',whiteSpace:'nowrap'}}>
      {[...TICKS,...TICKS].map((t,i)=>(
        <span key={i} style={{display:'inline-flex',gap:5,marginRight:24,fontFamily:'var(--ffm)',fontSize:10}}>
          <span style={{color:'var(--t2)'}}>{t.s}</span>
          <span style={{color:t.u?'var(--green)':'var(--red)'}}>{t.v}</span>
        </span>
      ))}
    </div>
  </div>
));

const MiniChart=memo(function MiniChart({data,color='#4F8EF7',h=60}){
  if(!data||data.length<2)return null;
  const uid=useRef(`mc${Math.random().toString(36).slice(2)}`).current;
  const W=300,pad=5;
  const mn=Math.min(...data),mx=Math.max(...data),rng=mx-mn||1;
  const pts=data.map((v,i)=>[(i/(data.length-1))*W,h-((v-mn)/rng)*(h-pad*2)-pad]);
  const line=pts.map((p,i)=>`${i?'L':'M'} ${p[0].toFixed(1)} ${p[1].toFixed(1)}`).join(' ');
  const dl=pts.reduce((acc,p,i)=>i?acc+Math.hypot(p[0]-pts[i-1][0],p[1]-pts[i-1][1]):0,0)+30;
  const last=pts[pts.length-1];
  return(
    <svg viewBox={`0 0 ${W} ${h}`} style={{width:'100%',height:h,display:'block'}}>
      <defs><linearGradient id={uid} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={color} stopOpacity=".18"/><stop offset="100%" stopColor={color} stopOpacity="0"/></linearGradient></defs>
      <path d={`${line} L ${W} ${h} L 0 ${h} Z`} fill={`url(#${uid})`}/>
      <path d={line} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" style={{strokeDasharray:dl,strokeDashoffset:dl,animation:'chart-draw 1s ease forwards'}}/>
      <circle cx={last[0]} cy={last[1]} r="2.8" fill={color} style={{filter:`drop-shadow(0 0 3px ${color}80)`}}/>
    </svg>
  );
});

const Burst=memo(function Burst({active,color='#0FD98A'}){
  if(!active)return null;
  return(
    <div style={{position:'absolute',inset:0,pointerEvents:'none',zIndex:40,overflow:'hidden'}}>
      {Array.from({length:12}).map((_,i)=>{
        const a=(i/12)*360,d=48+Math.random()*22;
        return<div key={i} style={{position:'absolute',top:'50%',left:'50%',width:5,height:5,borderRadius:'50%',background:color,filter:'blur(1px)','--bx':`${Math.cos(a*Math.PI/180)*d}px`,'--by':`${Math.sin(a*Math.PI/180)*d}px`,animation:`burst-p .65s ease-out ${i*20}ms forwards`}}/>;
      })}
    </div>
  );
});

const XPBar=memo(function XPBar({xp,streak,delta}){
  const lv=getLevel(xp),nxt=LEVELS[lv.idx+1];
  const pct=nxt?((xp-lv.min)/(nxt.min-lv.min))*100:100;
  return(
    <div style={{display:'flex',alignItems:'center',gap:7,background:'rgba(14,14,14,.95)',border:'1px solid var(--b2)',borderRadius:10,padding:'5px 10px',position:'relative',flexShrink:0}}>
      {delta>0&&<div key={delta+xp} style={{position:'absolute',top:-15,right:5,fontFamily:'var(--ffm)',fontSize:10,color:'var(--green)',fontWeight:700,animation:'xp-rise .9s ease forwards',pointerEvents:'none'}}>+{delta}</div>}
      <div>
        <div style={{fontSize:8,color:lv.color,fontFamily:'var(--ffm)',letterSpacing:'.1em'}}>{lv.name.toUpperCase()}</div>
        <div style={{display:'flex',alignItems:'center',gap:5,marginTop:3}}>
          <div style={{width:60,height:2.5,borderRadius:2,background:'rgba(255,255,255,.06)',overflow:'hidden'}}>
            <div style={{height:'100%',width:`${pct}%`,background:`linear-gradient(90deg,${lv.color},#9D6EF8)`,transition:'width 1s cubic-bezier(.34,1.56,.64,1)',borderRadius:2}}/>
          </div>
          <span style={{fontSize:10,color:lv.color,fontFamily:'var(--ffm)',fontWeight:700}}>{xp}</span>
        </div>
      </div>
      {streak>0&&<div style={{display:'flex',alignItems:'center',gap:2,background:'rgba(245,166,35,.1)',border:'1px solid rgba(245,166,35,.15)',borderRadius:6,padding:'2px 6px'}}><span style={{fontSize:10}}>ðŸ”¥</span><span style={{fontSize:9,fontFamily:'var(--ffm)',color:'var(--amber)',fontWeight:700}}>{streak}</span></div>}
    </div>
  );
});



// â”€â”€ AI ASSISTANT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AIAssistant({open,onToggle,nudge,nudgeKey,scenario,hasNav}){
  const [msgs,setMsgs]=useState([{role:'assistant',text:"Ask me anything â€” what is a stock, why prices move, how businesses make money. I'll explain it simply.",ui:true}]);
  const [input,setInput]=useState('');
  const [busy,setBusy]=useState(false);
  const [showBubble,setShowBubble]=useState(false);
  const [bubbleLeaving,setBubbleLeaving]=useState(false);
  const scrollEl=useRef(null),inputEl=useRef(null);
  const hideT=useRef(),leaveT=useRef();

  useEffect(()=>{
    if(!nudge||open)return;
    clearTimeout(hideT.current);clearTimeout(leaveT.current);
    setBubbleLeaving(false);setShowBubble(true);
    hideT.current=setTimeout(()=>{setBubbleLeaving(true);leaveT.current=setTimeout(()=>setShowBubble(false),300)},3800);
    return()=>{clearTimeout(hideT.current);clearTimeout(leaveT.current)};
  },[nudge,nudgeKey,open]);
  useEffect(()=>{if(open){setShowBubble(false);setBubbleLeaving(false)}},[open]);
  useEffect(()=>{scrollEl.current?.scrollTo({top:scrollEl.current.scrollHeight,behavior:'smooth'})},[msgs,busy]);
  useEffect(()=>{if(open){const t=setTimeout(()=>inputEl.current?.focus(),320);return()=>clearTimeout(t)}},[open]);

  const send=async()=>{
    const text=input.trim();if(!text||busy)return;
    H.light();setInput('');setBusy(true);
    const newMsgs=[...msgs,{role:'user',text,ui:false}];
    setMsgs(newMsgs);
    const apiMsgs=newMsgs.filter(m=>!m.ui).map(m=>({role:m.role,content:m.text}));
    const ctx=scenario?`\nCurrent game context: "${scenario}"`:'';
    try{
      const r=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json','anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:300,system:`You are the AI guide inside MarketPlay, a finance learning game for beginners.\nExplain finance, business, investing, and economics simply with real examples.\nTone: Smart helpful older sibling â€” direct, friendly.\nRules: Under 60 words. Real examples. No jargon without explanation.${ctx}`,messages:apiMsgs}),
      });
      const d=await r.json();
      const reply=d.content?.[0]?.text;
      setMsgs(m=>[...m,{role:'assistant',text:reply||'Could you rephrase that?',ui:false}]);
    }catch{
      setMsgs(m=>[...m,{role:'assistant',text:'Connection issue â€” check your API key and try again.',ui:false}]);
    }finally{setBusy(false)}
  };

  const OB=hasNav?76:14,PB=OB+46+8;
  return(
    <>
      {showBubble&&nudge&&(
        <div style={{position:'absolute',bottom:OB+46+8,right:60,maxWidth:168,background:'rgba(13,13,13,.98)',border:'1px solid rgba(79,142,247,.2)',borderRadius:'12px 12px 4px 12px',padding:'9px 12px',fontSize:12.5,color:'#E0E0E0',lineHeight:1.45,boxShadow:'0 4px 18px rgba(0,0,0,.55)',zIndex:118,textAlign:'right',pointerEvents:'none',animation:bubbleLeaving?'bubble-out .3s ease forwards':'bubble-in .28s cubic-bezier(.34,1.56,.64,1)'}}>
          {nudge}<div style={{width:0,height:0,borderLeft:'5px solid transparent',borderTop:'5px solid rgba(79,142,247,.2)',marginLeft:'auto',marginRight:12,marginTop:4}}/>
        </div>
      )}
      <div style={{position:'absolute',bottom:PB,right:12,width:'min(340px,calc(100% - 24px))',height:'38vh',background:'rgba(11,11,11,.98)',border:'1px solid var(--b2)',borderRadius:16,display:'flex',flexDirection:'column',overflow:'hidden',boxShadow:'0 -2px 32px rgba(0,0,0,.7)',zIndex:115,opacity:open?1:0,transform:open?'none':'translateY(16px) scale(.97)',pointerEvents:open?'auto':'none',transition:'opacity .26s ease,transform .28s cubic-bezier(.34,1.56,.64,1)'}}>
        <div style={{padding:'10px 14px 8px',borderBottom:'1px solid var(--b1)',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
          <div style={{display:'flex',alignItems:'center',gap:8}}>
            <div style={{width:22,height:22,borderRadius:'50%',background:'radial-gradient(circle at 35% 35%,#4F8EF7,#9D6EF8)',flexShrink:0}}/>
            <span style={{fontFamily:'var(--ffd)',fontSize:13,fontWeight:700}}>Ask anything</span>
          </div>
          <button onClick={()=>{H.light();onToggle()}} className="tap" style={{background:'rgba(255,255,255,.05)',borderRadius:7,padding:'3px 10px',color:'var(--t2)',fontSize:11,cursor:'pointer',border:'none'}}>close</button>
        </div>
        <div ref={scrollEl} style={{flex:1,overflow:'auto',padding:'10px 12px',display:'flex',flexDirection:'column',gap:8}}>
          {msgs.map((m,i)=>(
            <div key={i} style={{display:'flex',justifyContent:m.role==='user'?'flex-end':'flex-start',animation:'pop-in .18s ease'}}>
              <div style={{maxWidth:'88%',padding:'8px 11px',fontSize:12.5,lineHeight:1.5,borderRadius:m.role==='user'?'11px 11px 3px 11px':'11px 11px 11px 3px',background:m.role==='user'?'rgba(79,142,247,.13)':'rgba(255,255,255,.04)',border:m.role==='user'?'1px solid rgba(79,142,247,.2)':'1px solid var(--b1)',color:'var(--t1)'}}>{m.text}</div>
            </div>
          ))}
          {busy&&<div style={{display:'flex',justifyContent:'flex-start'}}><div style={{padding:'8px 12px',background:'rgba(255,255,255,.04)',border:'1px solid var(--b1)',borderRadius:'11px 11px 11px 3px',display:'flex',gap:4,alignItems:'center'}}>{[0,1,2].map(i=><div key={i} style={{width:4,height:4,borderRadius:'50%',background:'var(--t2)',animation:`dot-pulse .9s ease-in-out ${i*.16}s infinite`}}/>)}</div></div>}
        </div>
        <div style={{padding:'8px 10px 10px',borderTop:'1px solid var(--b1)',display:'flex',gap:7,alignItems:'center',flexShrink:0}}>
          <input ref={inputEl} value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="What is a stock? How do profits work?" style={{flex:1,height:36,background:'rgba(255,255,255,.05)',border:'1px solid var(--b2)',borderRadius:9,padding:'0 11px',color:'var(--t1)',fontSize:13}} onFocus={e=>e.target.style.borderColor='rgba(79,142,247,.4)'} onBlur={e=>e.target.style.borderColor='var(--b2)'}/>
          <button onClick={send} disabled={!input.trim()||busy} className="tap btn-glow" style={{width:36,height:36,borderRadius:9,flexShrink:0,background:input.trim()&&!busy?'linear-gradient(135deg,#4F8EF7,#9D6EF8)':'rgba(255,255,255,.06)',color:'#fff',fontSize:15,cursor:input.trim()&&!busy?'pointer':'default',display:'flex',alignItems:'center',justifyContent:'center',border:'none'}}>â†’</button>
        </div>
      </div>
      <button onClick={()=>{H.medium();onToggle()}} className="tap" style={{position:'absolute',bottom:OB,right:14,width:46,height:46,borderRadius:'50%',background:'radial-gradient(circle at 36% 34%,#4F8EF7,#9D6EF8)',zIndex:120,animation:'orb-float 3.2s ease-in-out infinite,orb-glow 2.2s ease-in-out infinite',display:'flex',alignItems:'center',justifyContent:'center',outline:open?'2.5px solid rgba(79,142,247,.55)':'none',outlineOffset:2,border:'none',cursor:'pointer'}}>
        <div style={{width:'40%',height:'40%',borderRadius:'50%',background:'rgba(255,255,255,.86)',filter:'blur(2px)',pointerEvents:'none'}}/>
        <div style={{position:'absolute',bottom:1,right:1,width:11,height:11,borderRadius:'50%',background:open?'var(--blue)':'var(--green)',border:'2px solid var(--bg)',pointerEvents:'none'}}/>
      </button>
    </>
  );
}

// â”€â”€ CHALLENGE SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ChallengeScreen({onComplete,onXP,onNudge,sessionCount}){
  const questions=useMemo(()=>pickQ(sessionCount,5),[sessionCount]);
  const [qi,setQi]=useState(0);
  const [sel,setSel]=useState(null);
  const [timer,setTimer]=useState(12);
  const [score,setScore]=useState(0);
  const [streak,setStreak]=useState(0);
  const [done,setDone]=useState(false);
  const [burst,setBurst]=useState(false);
  const [showXP,setShowXP]=useState(false);
  const [flash,setFlash]=useState(null);
  const [confetti,setConfetti]=useState([]);
  const [ripple,setRipple]=useState(null);
  const q=questions[qi];
  if(!q)return null;
  const xpEarned=sel===q.ans?(10+streak*5):0;
  const isUrgent=timer<=4;
  const DL=['','Beginner','Easy','Medium','Hard','Advanced'];
  const DC=['','#0FD98A','#4F8EF7','#F5A623','#F05252','#9D6EF8'];
  const tc=DC[q.tier]||'#4F8EF7';

  useEffect(()=>{
    if(sel!==null||done)return;
    if(timer===0){pick(-1);return}
    if(timer<=4)SFX.tickUrgent();else if(timer%3===0)SFX.tick();
    const t=setTimeout(()=>setTimer(s=>s-1),1000);
    return()=>clearTimeout(t);
  },[timer,sel,done]);

  const pick=useCallback((i)=>{
    if(sel!==null)return;
    setRipple(i);setTimeout(()=>setRipple(null),600);
    const correct=i===q.ans;
    if(correct){SFX.correct();H.success()}else{SFX.wrong();H.error()}
    setSel(i);setFlash(correct?'correct':'wrong');setTimeout(()=>setFlash(null),800);
    if(correct){
      const ns=streak+1;setStreak(ns);setScore(s=>s+1);
      setBurst(true);setTimeout(()=>setBurst(false),950);
      setShowXP(true);setTimeout(()=>setShowXP(false),1300);
      const cols=['#0FD98A','#4F8EF7','#F5A623','#9D6EF8','#F05252'];
      setConfetti(Array.from({length:14},(_,k)=>({id:k,color:cols[k%5],x:5+k*6.5,delay:k*.04,r:90+k*25})));
      setTimeout(()=>setConfetti([]),1200);
      onXP(10+ns*5);onNudge(cue('correct'));
    }else{setStreak(0);onNudge(cue('wrong'))}
  },[sel,q,streak,onXP,onNudge]);

  const next=()=>{
    H.light();SFX.step();
    if(qi<questions.length-1){setQi(q=>q+1);setSel(null);setTimer(12);setConfetti([])}
    else{setDone(true);SFX.complete();onXP(score*15+30)}
  };

  if(done)return(
    <div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:28,animation:'screen-in .4s ease',position:'relative',overflow:'hidden'}}>
      <div style={{position:'absolute',inset:0,background:'radial-gradient(ellipse 70% 60% at 50% 40%,rgba(15,217,138,.08),transparent)',pointerEvents:'none'}}/>
      <Burst active={true} color="#F5A623"/>
      <div style={{fontSize:62,marginBottom:10,animation:'result-drop .5s cubic-bezier(.34,1.56,.64,1)'}}>{score===questions.length?'ðŸ†':score>=4?'ðŸŽ¯':score>=3?'ðŸŽ“':'ðŸ“š'}</div>
      <div style={{position:'relative',width:110,height:110,marginBottom:18}}>
        <svg viewBox="0 0 100 100" style={{position:'absolute',inset:0,transform:'rotate(-90deg)'}}>
          <circle cx="50" cy="50" r="44" fill="none" stroke="rgba(255,255,255,.06)" strokeWidth="6"/>
          <circle cx="50" cy="50" r="44" fill="none" stroke={score>=4?'#0FD98A':score>=3?'#4F8EF7':'#9D6EF8'} strokeWidth="6" strokeLinecap="round" strokeDasharray={`${(score/questions.length)*276.5} 276.5`} style={{transition:'stroke-dasharray .8s cubic-bezier(.34,1.56,.64,1)',filter:`drop-shadow(0 0 6px ${score>=4?'#0FD98A':'#4F8EF7'}80)`}}/>
        </svg>
        <div style={{position:'absolute',inset:0,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center'}}>
          <div style={{fontFamily:'var(--ffd)',fontSize:28,fontWeight:800}}>{score}/{questions.length}</div>
          <div style={{fontSize:9,fontFamily:'var(--ffm)',color:'var(--t3)',letterSpacing:'.1em'}}>CORRECT</div>
        </div>
      </div>
      <div style={{fontFamily:'var(--ffd)',fontSize:20,fontWeight:800,color:score===questions.length?'#F5A623':score>=3?'#0FD98A':'#4F8EF7',marginBottom:8,textAlign:'center'}}>{score===questions.length?'Perfect round!':score>=4?'Really sharp.':score>=3?'Good read.':'Keep building.'}</div>
      <div style={{display:'flex',gap:7,marginBottom:20}}>{questions.map((_,i)=><div key={i} style={{width:11,height:11,borderRadius:'50%',background:i<score?'#0FD98A':'rgba(255,255,255,.1)',boxShadow:i<score?'0 0 8px rgba(15,217,138,.6)':'none'}}/>)}</div>
      <div style={{background:'rgba(15,217,138,.08)',border:'1px solid rgba(15,217,138,.2)',borderRadius:12,padding:'10px 22px',fontFamily:'var(--ffm)',fontSize:13,color:'#0FD98A',fontWeight:700,marginBottom:28}}>â­ +{score*15+30} XP earned</div>
      <button onClick={onComplete} className="tap btn-glow" style={{padding:'16px 40px',borderRadius:14,background:'linear-gradient(135deg,#4F8EF7,#9D6EF8)',color:'#fff',fontFamily:'var(--ffd)',fontSize:15,fontWeight:800,cursor:'pointer',border:'none',boxShadow:'0 0 28px rgba(79,142,247,.38)'}}>Start Training â†’</button>
    </div>
  );

  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden',position:'relative'}}>
      {confetti.map(c=><div key={c.id} style={{position:'absolute',top:-10,left:`${c.x}%`,width:6,height:6,borderRadius:2,background:c.color,opacity:.9,'--r':`${c.r}deg`,animation:`confetti-fall .8s ease ${c.delay}s forwards`,pointerEvents:'none'}}/>)}
      {flash==='correct'&&<div style={{position:'absolute',inset:0,background:'radial-gradient(ellipse 80% 50% at 50% 30%,rgba(15,217,138,.12),transparent)',zIndex:50,pointerEvents:'none',animation:'flash-green .8s ease forwards'}}/>}
      {flash==='wrong'&&<div style={{position:'absolute',inset:0,background:'radial-gradient(ellipse 80% 50% at 50% 30%,rgba(240,82,82,.1),transparent)',zIndex:50,pointerEvents:'none',animation:'flash-red .8s ease forwards'}}/>}
      {showXP&&<div style={{position:'absolute',top:'16%',left:'50%',zIndex:60,pointerEvents:'none',transform:'translateX(-50%)',fontFamily:'var(--ffm)',fontSize:24,fontWeight:700,color:'#0FD98A',textShadow:'0 0 24px rgba(15,217,138,.9)',animation:'xp-burst 1.2s cubic-bezier(.34,1.56,.64,1) forwards',whiteSpace:'nowrap'}}>+{xpEarned} XP{streak>1?` ðŸ”¥${streak}x`:''}</div>}
      <div style={{padding:'12px 18px 6px',flexShrink:0,display:'flex',justifyContent:'space-between',alignItems:'center',borderBottom:'1px solid rgba(255,255,255,.04)'}}>
        <div style={{display:'flex',gap:6,alignItems:'center'}}>
          {questions.map((_,i)=><div key={i} style={{width:i===qi?22:i<qi?10:8,height:8,borderRadius:4,background:i===qi?'linear-gradient(90deg,#4F8EF7,#9D6EF8)':i<qi?'#0FD98A':'rgba(255,255,255,.1)',transition:'all .35s cubic-bezier(.34,1.56,.64,1)'}}/>)}
          <span style={{fontFamily:'var(--ffm)',fontSize:9,color:'var(--t3)',marginLeft:4}}>{qi+1}/{questions.length}</span>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          {streak>=2&&<div style={{display:'flex',alignItems:'center',gap:3,background:'rgba(245,166,35,.14)',border:'1px solid rgba(245,166,35,.3)',borderRadius:20,padding:'3px 10px',animation:'streak-fire .5s ease-in-out infinite alternate'}}><span style={{fontSize:13}}>ðŸ”¥</span><span style={{fontFamily:'var(--ffd)',fontSize:12,color:'#F5A623',fontWeight:800}}>{streak}x</span></div>}
          <div style={{position:'relative',width:44,height:44,flexShrink:0,animation:isUrgent?'ring-urgent .5s ease-in-out infinite':'none'}}>
            <svg viewBox="0 0 40 40" style={{position:'absolute',inset:0,transform:'rotate(-90deg)'}}>
              <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,.06)" strokeWidth="3"/>
              <circle cx="20" cy="20" r="16" fill="none" stroke={isUrgent?'#F05252':timer<=7?'#F5A623':'#4F8EF7'} strokeWidth="3" strokeLinecap="round" strokeDasharray={`${(timer/12)*100.5} 100.5`} style={{transition:'stroke-dasharray .9s linear,stroke .3s',filter:isUrgent?'drop-shadow(0 0 4px #F05252)':'none'}}/>
            </svg>
            <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'var(--ffm)',fontSize:13,fontWeight:700,color:isUrgent?'#F05252':timer<=7?'#F5A623':'#4F8EF7'}}>{timer}</div>
          </div>
        </div>
      </div>
      <div key={qi} style={{flex:1,overflow:'auto',padding:'12px 18px 4px'}}>
        <div style={{display:'flex',gap:6,marginBottom:10}}>
          <span style={{fontFamily:'var(--ffm)',fontSize:8.5,color:'var(--t2)',background:'rgba(255,255,255,.06)',borderRadius:20,padding:'3px 10px'}}>{q.cat}</span>
          <span style={{fontFamily:'var(--ffm)',fontSize:8.5,color:tc,background:`${tc}1a`,borderRadius:20,padding:'3px 10px',border:`1px solid ${tc}35`}}>{DL[q.tier]}</span>
        </div>
        <QuestionVisual visual={q.visual}/>
        <div style={{fontFamily:'var(--ffd)',fontSize:18,fontWeight:800,lineHeight:1.28,letterSpacing:'-.025em',marginBottom:16,background:'linear-gradient(135deg,#F2F0EE 55%,rgba(157,110,248,.75))',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',animation:'q-dramatic .32s cubic-bezier(.34,1.56,.64,1) .06s both'}}>{q.q}</div>
        <div style={{display:'flex',flexDirection:'column',gap:9,position:'relative'}}>
          <Burst active={burst} color="#0FD98A"/>
          {q.opts.map((o,i)=>{
            const correct=sel!==null&&i===q.ans,wrong=sel===i&&i!==q.ans,neutral=sel!==null&&i!==q.ans&&i!==sel;
            return(
              <button key={i} onClick={()=>pick(i)} className="tap" style={{padding:'13px 16px',borderRadius:14,background:correct?'rgba(15,217,138,.13)':wrong?'rgba(240,82,82,.12)':neutral?'rgba(255,255,255,.018)':'rgba(255,255,255,.05)',border:correct?'1px solid rgba(15,217,138,.5)':wrong?'1px solid rgba(240,82,82,.45)':neutral?'1px solid rgba(255,255,255,.04)':'1px solid rgba(255,255,255,.09)',color:correct?'#0FD98A':wrong?'#F05252':neutral?'var(--t3)':'var(--t1)',fontFamily:'var(--ffb)',fontSize:13.5,fontWeight:500,textAlign:'left',cursor:sel!==null?'default':'pointer',display:'flex',alignItems:'center',gap:11,transition:'background .25s,border-color .25s,color .25s',animation:wrong?'shake-card .4s ease':sel!==null?'none':`option-in .28s cubic-bezier(.34,1.56,.64,1) ${i*65}ms both`,position:'relative',overflow:'hidden',boxShadow:correct?'0 0 18px rgba(15,217,138,.18)':wrong?'0 0 12px rgba(240,82,82,.14)':'none'}}>
                {ripple===i&&<div style={{position:'absolute',top:'50%',left:'50%',width:20,height:20,borderRadius:'50%',border:'2px solid rgba(79,142,247,.6)',transform:'translate(-50%,-50%)',animation:'ripple-out .6s ease',pointerEvents:'none'}}/>}
                {correct&&<div style={{position:'absolute',inset:0,background:'linear-gradient(90deg,rgba(15,217,138,.1),transparent)',animation:'sweep-green .4s ease',transformOrigin:'left',pointerEvents:'none'}}/>}
                <div style={{width:28,height:28,borderRadius:9,flexShrink:0,display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'var(--ffm)',fontSize:11,fontWeight:700,background:correct?'rgba(15,217,138,.22)':wrong?'rgba(240,82,82,.2)':'rgba(255,255,255,.08)',color:correct?'#0FD98A':wrong?'#F05252':'var(--t3)',transition:'all .2s'}}>{correct?'âœ“':wrong?'âœ—':String.fromCharCode(65+i)}</div>
                {o}
              </button>
            );
          })}
        </div>
        {sel!==null&&q.explain&&(
          <div style={{marginTop:14,padding:'14px 16px',background:'rgba(79,142,247,.07)',border:'1px solid rgba(79,142,247,.2)',borderRadius:14,animation:'slide-up-in .4s cubic-bezier(.34,1.56,.64,1)',position:'relative',overflow:'hidden'}}>
            <div style={{position:'absolute',top:0,left:0,width:3,height:'100%',background:'linear-gradient(180deg,#4F8EF7,#9D6EF8)',borderRadius:'14px 0 0 14px'}}/>
            <div style={{fontFamily:'var(--ffm)',fontSize:8,color:'var(--blue)',letterSpacing:'.15em',marginBottom:6}}>ðŸ’¡ EXPLAINED</div>
            <p style={{fontSize:13,lineHeight:1.65,color:'#D0D0D0'}}>{q.explain}</p>
          </div>
        )}
      </div>
      {sel!==null&&(
        <div style={{padding:'8px 18px 14px',flexShrink:0}}>
          <button onClick={next} className="tap btn-glow" style={{width:'100%',padding:'16px',borderRadius:14,border:'none',background:sel===q.ans?'linear-gradient(135deg,#0FD98A,#4F8EF7)':'linear-gradient(135deg,#4F8EF7,#9D6EF8)',color:'#fff',fontFamily:'var(--ffd)',fontSize:15,fontWeight:800,cursor:'pointer',boxShadow:sel===q.ans?'0 0 28px rgba(15,217,138,.4)':'0 0 20px rgba(79,142,247,.3)'}}>
            {qi===questions.length-1?'See Results â†’':sel===q.ans?'Nice! Next â†’':'Next â†’'}
          </button>
        </div>
      )}
    </div>
  );
}

// â”€â”€ LESSON SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function StepNodes({total,current}){
  return(
    <div style={{display:'flex',alignItems:'center',flexShrink:0}}>
      {Array.from({length:total}).map((_,i)=>{
        const done=i<current,active=i===current;
        return(
          <div key={i} style={{display:'flex',alignItems:'center'}}>
            <div style={{position:'relative',width:active?20:done?8:6,height:active?20:done?8:6,borderRadius:'50%',background:active?'linear-gradient(135deg,#4F8EF7,#9D6EF8)':done?'var(--green)':'rgba(255,255,255,.12)',transition:'all .4s cubic-bezier(.34,1.56,.64,1)',boxShadow:active?'0 0 12px rgba(79,142,247,.7)':done?'0 0 6px rgba(15,217,138,.4)':'none',display:'flex',alignItems:'center',justifyContent:'center'}}>
              {done&&<div style={{fontSize:8,color:'#fff',fontWeight:700}}>âœ“</div>}
              {active&&<div style={{position:'absolute',inset:0,borderRadius:'50%',border:'2px solid rgba(79,142,247,.5)',animation:'node-ping 1.4s ease-out infinite'}}/>}
            </div>
            {i<total-1&&<div style={{width:active||done?16:10,height:1.5,background:done?'var(--green)':'rgba(255,255,255,.08)',margin:'0 2px',transition:'all .4s ease'}}/>}
          </div>
        );
      })}
    </div>
  );
}

function LessonScreen({onComplete,onXP,onNudge,onScenario}){
  const [step,setStep]=useState(0);
  const [sel,setSel]=useState(null);
  const [shown,setShown]=useState(false);
  const [burst,setBurst]=useState(false);
  const [alloc,setAlloc]=useState({gold:25,tech:25,bonds:25,oil:25});
  const [selA,setSelA]=useState(null);
  const [xpFlash,setXpFlash]=useState(false);
  const s=LESSON[step];
  const ACCENTS=['#4F8EF7','#9D6EF8','#F5A623','#F05252','#4F8EF7','#0FD98A'];
  const accent=ACCENTS[step]||'#4F8EF7';
  const totalAlloc=Object.values(alloc).reduce((a,b)=>a+b,0);

  useEffect(()=>{
    SFX.step();onNudge(cue(s.cueKey||'start'));
    if(s.headline)onScenario(s.headline);
    setSel(null);setShown(false);setBurst(false);setSelA(null);
  },[step]);

  const pick=useCallback((id)=>{
    if(sel)return;
    const correct=id===s.ans;
    if(correct){SFX.correct();H.success()}else{SFX.wrong();H.error()}
    setSel(id);setShown(true);
    if(correct){setBurst(true);setTimeout(()=>setBurst(false),900);setXpFlash(true);setTimeout(()=>setXpFlash(false),1200);onXP(30);onNudge(cue('correct'))}
    else onNudge(cue('wrong'));
  },[sel,s,onXP,onNudge]);

  const next=()=>{
    H.light();SFX.step();
    if(step<LESSON.length-1)setStep(t=>t+1);
    else{SFX.complete();onXP(120);onComplete()}
  };

  const cStyle=id=>{
    if(!shown)return{bg:'rgba(255,255,255,.04)',bo:'1px solid var(--b1)',co:'var(--t1)'};
    if(id===s.ans)return{bg:'rgba(15,217,138,.1)',bo:'1px solid rgba(15,217,138,.35)',co:'#0FD98A'};
    if(id===sel)return{bg:'rgba(240,82,82,.08)',bo:'1px solid rgba(240,82,82,.28)',co:'#F05252'};
    return{bg:'rgba(255,255,255,.02)',bo:'1px solid rgba(255,255,255,.03)',co:'var(--t3)'};
  };

  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden',position:'relative'}}>
      <div style={{position:'absolute',inset:0,pointerEvents:'none',zIndex:0,background:`radial-gradient(ellipse 80% 45% at 50% 0%,${accent}12 0%,transparent 70%)`}}/>
      <div style={{padding:'10px 18px 8px',flexShrink:0,display:'flex',alignItems:'center',justifyContent:'space-between',position:'relative',zIndex:2}}>
        <StepNodes total={LESSON.length} current={step}/>
        <div style={{position:'relative'}}>
          {xpFlash&&<div style={{position:'absolute',right:0,top:-20,fontFamily:'var(--ffm)',fontSize:12,color:'var(--green)',fontWeight:700,animation:'xp-rise .9s ease forwards',whiteSpace:'nowrap'}}>+30 XP âœ¨</div>}
          <div style={{fontFamily:'var(--ffm)',fontSize:9,color:'var(--t3)'}}>{step+1}/{LESSON.length}</div>
        </div>
      </div>
      <div key={step} style={{flex:1,overflow:'auto',padding:'0 18px 8px',position:'relative',zIndex:2}}>
        <div style={{marginBottom:14,padding:'16px 18px',borderRadius:16,background:`linear-gradient(135deg,${accent}10 0%,rgba(255,255,255,.02) 100%)`,border:`1px solid ${accent}28`,position:'relative',overflow:'hidden',animation:'scene-drop .35s cubic-bezier(.34,1.56,.64,1)'}}>
          <div style={{position:'absolute',inset:0,borderRadius:16,border:`1px solid ${accent}`,opacity:.18,animation:'border-glow 2.4s ease-in-out infinite',pointerEvents:'none'}}/>
          <div style={{position:'absolute',top:0,left:0,width:3,height:'100%',background:`linear-gradient(180deg,${accent},transparent)`,borderRadius:'16px 0 0 16px'}}/>
          <div style={{fontFamily:'var(--ffm)',fontSize:8,color:accent,letterSpacing:'.15em',marginBottom:6,opacity:.8}}>{['SCENARIO','DISCOVERY','PRACTICE','INSIGHT','ANALYSIS','KEY RULES'][step]||'LESSON'}</div>
          <h2 style={{fontFamily:'var(--ffd)',fontSize:20,fontWeight:800,letterSpacing:'-.025em',lineHeight:1.2,color:'var(--t1)'}}>{s.headline}</h2>
          {(s.body||s.insight)&&<p style={{color:'var(--t2)',fontSize:13,lineHeight:1.6,marginTop:8}}>{s.body||s.insight}</p>}
        </div>

        {s.type==='choice'&&(
          <div style={{position:'relative'}}>
            <div style={{fontFamily:'var(--ffd)',fontSize:14,fontWeight:700,color:'var(--t1)',marginBottom:12,lineHeight:1.35}}>{s.q}</div>
            <Burst active={burst} color={accent}/>
            <div style={{display:'flex',flexDirection:'column',gap:8}}>
              {s.opts.map((o,idx)=>{
                const cs=cStyle(o.id),isAns=o.id===s.ans,isSel=o.id===sel;
                return(
                  <button key={o.id} onClick={()=>pick(o.id)} className="tap" style={{padding:'13px 16px',borderRadius:13,background:cs.bg,border:cs.bo,color:cs.co,fontFamily:'var(--ffb)',fontSize:13.5,fontWeight:500,textAlign:'left',cursor:sel?'default':'pointer',display:'flex',alignItems:'center',gap:11,transition:'background .22s,border-color .22s,color .22s',animation:shown&&isSel&&!isAns?'shake-card .4s ease':undefined,position:'relative',overflow:'hidden'}}>
                    {shown&&isAns&&<div style={{position:'absolute',inset:0,background:'linear-gradient(90deg,rgba(15,217,138,.08),transparent)',animation:'sweep-green .35s ease',transformOrigin:'left',pointerEvents:'none'}}/>}
                    <div style={{width:26,height:26,borderRadius:8,flexShrink:0,display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'var(--ffm)',fontSize:10,fontWeight:700,background:shown&&isAns?'rgba(15,217,138,.2)':shown&&isSel?'rgba(240,82,82,.2)':'rgba(255,255,255,.07)',color:shown&&isAns?'#0FD98A':shown&&isSel?'#F05252':'var(--t3)',transition:'all .2s'}}>{shown&&isAns?'âœ“':shown&&isSel?'âœ—':String.fromCharCode(65+idx)}</div>
                    {o.l}
                  </button>
                );
              })}
            </div>
            {shown&&s.explain&&(
              <div style={{marginTop:14,padding:'14px 16px',background:'rgba(79,142,247,.07)',border:'1px solid rgba(79,142,247,.2)',borderRadius:13,animation:'slide-up-in .4s cubic-bezier(.34,1.56,.64,1)',position:'relative',overflow:'hidden'}}>
                <div style={{position:'absolute',top:0,left:0,width:3,height:'100%',background:'linear-gradient(180deg,#4F8EF7,#9D6EF8)',borderRadius:'13px 0 0 13px'}}/>
                <div style={{fontFamily:'var(--ffm)',fontSize:8,color:'var(--blue)',letterSpacing:'.14em',marginBottom:6}}>ðŸ’¡ WHY THIS IS CORRECT</div>
                <p style={{fontSize:13,lineHeight:1.65,color:'#D8D8D8'}}>{s.explain}</p>
              </div>
            )}
          </div>
        )}

        {s.type==='reveal'&&(
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            <div style={{padding:'18px',borderRadius:16,background:'linear-gradient(135deg,rgba(79,142,247,.08),rgba(157,110,248,.06))',border:'1px solid rgba(79,142,247,.22)',animation:'insight-rise .5s cubic-bezier(.34,1.56,.64,1)'}}>
              <div style={{fontFamily:'var(--ffm)',fontSize:8,color:'#9D6EF8',letterSpacing:'.16em',marginBottom:10}}>âœ¦ MARKET INSIGHT</div>
              <p style={{fontSize:14,lineHeight:1.7,color:'var(--t1)',fontWeight:500}}>{s.insight}</p>
            </div>
            <div style={{display:'flex',gap:10,padding:'10px 14px',background:'rgba(245,166,35,.06)',border:'1px solid rgba(245,166,35,.18)',borderRadius:12}}>
              <span style={{fontSize:18,flexShrink:0}}>ðŸ’¡</span>
              <p style={{fontSize:12,color:'rgba(245,166,35,.9)',lineHeight:1.55}}>This pattern repeats in markets constantly â€” learn to spot it and you'll read headlines differently forever.</p>
            </div>
          </div>
        )}

        {s.type==='allocate'&&s.assets&&(
          <div style={{display:'flex',flexDirection:'column',gap:8}}>
            <div style={{padding:'10px 14px',borderRadius:12,background:'rgba(255,255,255,.03)',border:'1px solid var(--b1)',display:'flex',alignItems:'center',gap:12,marginBottom:4}}>
              <div style={{flex:1,height:4,background:'rgba(255,255,255,.07)',borderRadius:2,overflow:'hidden',position:'relative'}}>
                <div style={{position:'absolute',top:0,left:0,height:'100%',width:`${Math.min(100,totalAlloc)}%`,background:totalAlloc>100?'var(--red)':totalAlloc===100?'var(--green)':'var(--blue)',borderRadius:2,transition:'width .3s cubic-bezier(.34,1.56,.64,1)'}}/>
              </div>
              <span style={{fontFamily:'var(--ffm)',fontSize:13,fontWeight:700,color:totalAlloc===100?'var(--green)':totalAlloc>100?'var(--red)':'var(--t2)',flexShrink:0}}>{totalAlloc}% {totalAlloc===100&&'âœ…'}</span>
            </div>
            {s.assets.map((a,idx)=>{
              const active=selA===a.id,pct=alloc[a.id]||0;
              return(
                <div key={a.id} style={{animation:`option-in .28s ease ${idx*60}ms both`}}>
                  <button onClick={()=>{setSelA(active?null:a.id);SFX.tap();H.light()}} className="tap" style={{width:'100%',padding:'12px 14px',borderRadius:13,cursor:'pointer',textAlign:'left',background:active?'rgba(79,142,247,.1)':pct>0?'rgba(255,255,255,.05)':'rgba(255,255,255,.02)',border:active?'1px solid rgba(79,142,247,.4)':pct>0?'1px solid rgba(255,255,255,.1)':'1px solid rgba(255,255,255,.05)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div style={{display:'flex',gap:10,alignItems:'center'}}>
                      <div style={{width:38,height:38,borderRadius:11,background:'rgba(255,255,255,.07)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:19}}>{a.icon}</div>
                      <div><div style={{fontSize:13.5,fontWeight:700}}>{a.n}</div><div style={{fontSize:11,color:'var(--t3)',marginTop:2}}>{a.hint}</div></div>
                    </div>
                    <div style={{fontFamily:'var(--ffm)',fontSize:13,fontWeight:700,color:pct>0?'var(--blue)':'var(--t3)',background:pct>0?'rgba(79,142,247,.14)':'rgba(255,255,255,.04)',padding:'4px 11px',borderRadius:8}}>{pct}%</div>
                  </button>
                  {active&&(
                    <div style={{display:'flex',gap:6,padding:'8px 2px 2px',animation:'pop-in .18s cubic-bezier(.34,1.56,.64,1)'}}>
                      {[0,25,50,75,100].map(p=>(
                        <button key={p} onClick={()=>{setAlloc(v=>({...v,[a.id]:p}));SFX.allocate();H.light()}} className="tap" style={{flex:1,padding:'9px 0',borderRadius:10,cursor:'pointer',background:pct===p?'rgba(79,142,247,.22)':'rgba(255,255,255,.05)',color:pct===p?'#4F8EF7':'var(--t2)',fontFamily:'var(--ffm)',fontSize:11,fontWeight:pct===p?700:400,border:pct===p?'1px solid rgba(79,142,247,.35)':'1px solid transparent',transition:'all .15s'}}>{p===0?'âœ•':p+'%'}</button>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {s.type==='insight'&&s.rules&&(
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            {s.rules.map((r,i)=>{
              const rc=['#4F8EF7','#9D6EF8','#0FD98A'][i]||'#4F8EF7';
              return(
                <div key={i} style={{display:'flex',alignItems:'stretch',borderRadius:14,overflow:'hidden',border:`1px solid ${rc}22`,animation:`insight-rise .4s cubic-bezier(.34,1.56,.64,1) ${i*100}ms both`}}>
                  <div style={{width:4,background:`linear-gradient(180deg,${rc},${rc}66)`,flexShrink:0}}/>
                  <div style={{flex:1,padding:'14px 15px',background:'rgba(255,255,255,.03)',display:'flex',gap:11,alignItems:'flex-start'}}>
                    <div style={{width:38,height:38,borderRadius:11,background:`linear-gradient(135deg,${rc}22,${rc}0a)`,border:`1px solid ${rc}30`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:18,flexShrink:0}}>{r.icon}</div>
                    <div>
                      <div style={{fontSize:13.5,fontWeight:700,fontFamily:'var(--ffd)',marginBottom:4}}>{r.rule}</div>
                      <div style={{fontSize:12,color:'var(--t2)',lineHeight:1.55}}>{r.sub}</div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
      <div style={{padding:'8px 18px 16px',flexShrink:0,position:'relative',zIndex:2}}>
        {(shown||s.type==='reveal'||s.type==='allocate'||s.type==='insight')&&(
          <button onClick={next} className="tap btn-glow" style={{width:'100%',padding:'16px',borderRadius:14,background:step===LESSON.length-1?'linear-gradient(135deg,#0FD98A,#4F8EF7)':`linear-gradient(135deg,${accent},#9D6EF8)`,color:'#fff',fontFamily:'var(--ffd)',fontSize:15,fontWeight:800,cursor:'pointer',border:'none',boxShadow:`0 0 24px ${accent}40`}}>
            {step===LESSON.length-1?'âœ“ Complete Lesson':step===LESSON.length-2?'See the Rules â†’':'Got it. Next â†’'}
          </button>
        )}
      </div>
    </div>
  );
}

// â”€â”€ TRADE SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TradeScreen({onXP,onNudge,onScenario}){
  const [round,setRound]=useState(0);
  const session=useMemo(generateSession,[round]);
  const [alloc,setAlloc]=useState({});
  const [selA,setSelA]=useState(null);
  const [timer,setTimer]=useState(15);
  const [phase,setPhase]=useState('decide');
  const [paths,setPaths]=useState({});
  const [result,setResult]=useState(null);
  const [animAt,setAnimAt]=useState(-1);

  useEffect(()=>{
    const o={};session.assets.forEach(a=>{o[a.id]=0});setAlloc(o);
    setSelA(null);setTimer(15);setPhase('decide');setPaths({});setResult(null);setAnimAt(-1);
    onNudge(cue('trade'));onScenario(session.headline);
  },[session]);

  const total=Object.values(alloc).reduce((a,b)=>a+b,0);

  useEffect(()=>{
    if(phase!=='decide')return;
    if(timer===0){execute();return}
    const t=setTimeout(()=>setTimer(s=>s-1),1000);
    return()=>clearTimeout(t);
  },[timer,phase]);

  const execute=useCallback(()=>{
    H.medium();setPhase('simulate');onNudge('Watching how the market respondsâ€¦');
    const np={};
    session.assets.forEach(a=>{np[a.id]=pricePath(16,a.expected,a.vol,Math.random())});
    setPaths(np);
    let i=0;
    const iv=setInterval(()=>{
      setAnimAt(i);i++;
      if(i>=session.assets.length){clearInterval(iv);buildResult(np)}
    },360);
  },[session,alloc]);

  const buildResult=p=>{
    const rets={};let portfolio=0;
    session.assets.forEach(a=>{
      const path=p[a.id],ret=+((path[path.length-1]-path[0])/path[0]*100).toFixed(1);
      rets[a.id]=ret;portfolio+=(alloc[a.id]/100)*ret;
    });
    const port=+portfolio.toFixed(1);
    setResult({rets,port});setPhase('result');
    onXP(Math.max(8,Math.round(Math.abs(port)*1.8+12)));
    onNudge(port>5?cue('correct'):port>0?'Thin edge. Study the drivers.':cue('wrong'));
  };

  if(phase==='simulate')return(
    <div style={{flex:1,display:'flex',flexDirection:'column',padding:18,gap:14}}>
      <div style={{fontFamily:'var(--ffd)',fontSize:20,fontWeight:800,animation:'screen-in .28s ease'}}>Simulatingâ€¦</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
        {session.assets.map((a,i)=>{
          const ready=i<=animAt,col=a.expected>0?'#0FD98A':a.expected<0?'#F05252':'#888';
          return(
            <div key={a.id} style={{background:'var(--card)',border:`1px solid ${ready?'var(--b2)':'var(--b1)'}`,borderRadius:10,padding:'10px 9px',opacity:ready?1:.2,transform:ready?'scale(1)':'scale(.96)',transition:'opacity .3s,transform .3s'}}>
              <div style={{fontSize:10,color:'var(--t2)',marginBottom:5,display:'flex',justifyContent:'space-between'}}>
                <span>{a.icon} {a.n}</span>
                {ready&&<span style={{color:col}}>{a.expected>0?'â†‘':a.expected<0?'â†“':'â†’'}</span>}
              </div>
              {ready&&paths[a.id]&&<MiniChart data={paths[a.id]} color={col} h={38}/>}
            </div>
          );
        })}
      </div>
    </div>
  );

  if(phase==='result'&&result)return(
    <div style={{flex:1,overflow:'auto',padding:'0 18px 18px',animation:'screen-in .32s ease'}}>
      <div style={{textAlign:'center',padding:'18px 0 16px',borderBottom:'1px solid var(--b1)'}}>
        <div style={{fontFamily:'var(--ffm)',fontSize:9,color:'var(--t2)',letterSpacing:'.1em',marginBottom:5}}>YOUR RETURN</div>
        <div style={{fontFamily:'var(--ffd)',fontSize:52,fontWeight:800,letterSpacing:'-.04em',lineHeight:1,color:result.port>0?'var(--green)':'var(--red)',animation:'pop-in .4s cubic-bezier(.34,1.56,.64,1)'}}>{result.port>0?'+':''}{result.port}%</div>
        <div style={{marginTop:7,fontSize:12,color:'var(--t2)'}}>{result.port>10?'Strong read on the scenario.':result.port>3?'Decent. Check the reasoning.':result.port>0?'Thin edge.':'The market humbled you. Good.'}</div>
      </div>
      <div style={{display:'flex',flexDirection:'column',marginTop:12}}>
        {session.assets.map(a=>{
          const r=result.rets[a.id],ap=alloc[a.id],contrib=+((ap/100)*r).toFixed(2);
          return(
            <div key={a.id} style={{padding:'10px 0',borderBottom:'1px solid rgba(255,255,255,.03)',display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
              <div style={{display:'flex',gap:9,alignItems:'flex-start'}}><span style={{fontSize:16,marginTop:1}}>{a.icon}</span><div><div style={{fontSize:13,fontWeight:600}}>{a.n}</div><div style={{fontSize:10.5,color:'var(--t2)',marginTop:1.5,maxWidth:185}}>{a.hint}</div></div></div>
              <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:1.5,flexShrink:0,marginLeft:8}}>
                <span style={{fontFamily:'var(--ffm)',fontSize:12,fontWeight:700,color:r>0?'var(--green)':'var(--red)'}}>{r>0?'+':''}{r}%</span>
                {ap>0&&<span style={{fontSize:9.5,color:'var(--t3)',fontFamily:'var(--ffm)'}}>{ap}% â†’ {contrib>0?'+':''}{contrib}%</span>}
              </div>
            </div>
          );
        })}
      </div>
      <button onClick={()=>{H.medium();setRound(r=>r+1)}} className="tap btn-glow" style={{width:'100%',padding:'15px',borderRadius:12,border:'none',background:'linear-gradient(135deg,#4F8EF7,#9D6EF8)',color:'#fff',fontFamily:'var(--ffd)',fontSize:14.5,fontWeight:700,cursor:'pointer',marginTop:20,boxShadow:'0 0 20px rgba(79,142,247,.32)'}}>âš¡ Next Round â†’</button>
    </div>
  );

  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden'}}>
      <div style={{margin:'10px 18px 0',padding:'12px 14px',background:`${session.color}0A`,border:`1px solid ${session.color}22`,borderRadius:12,flexShrink:0,animation:'pop-in .26s ease'}}>
        <div style={{fontSize:14.5,fontWeight:700,fontFamily:'var(--ffd)',marginBottom:3}}>{session.headline}</div>
        <div style={{fontSize:11.5,color:'var(--t2)',lineHeight:1.45}}>{session.sub}</div>
      </div>
      <div style={{flex:1,overflow:'auto',padding:'10px 18px 0',display:'flex',flexDirection:'column',gap:6}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:2}}>
          <span style={{fontSize:11,color:'var(--t3)'}}>Tap to allocate Â· {total}% used</span>
          <div style={{position:'relative',width:44,height:44}}>
            <svg viewBox="0 0 40 40" style={{position:'absolute',inset:0,transform:'rotate(-90deg)'}}>
              <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,.06)" strokeWidth="3"/>
              <circle cx="20" cy="20" r="16" fill="none" stroke={timer<=5?'#F05252':timer<=10?'#F5A623':'#4F8EF7'} strokeWidth="3" strokeLinecap="round" strokeDasharray={`${(timer/15)*100.5} 100.5`} style={{transition:'stroke-dasharray .9s linear,stroke .3s'}}/>
            </svg>
            <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'var(--ffm)',fontSize:11,fontWeight:700,color:timer<=5?'#F05252':timer<=10?'#F5A623':'#4F8EF7'}}>{timer}</div>
          </div>
        </div>
        {session.assets.map(a=>{
          const active=selA===a.id,pct=alloc[a.id]||0;
          return(
            <div key={a.id}>
              <button onClick={()=>{setSelA(active?null:a.id);H.light()}} className="tap" style={{width:'100%',padding:'10px 13px',borderRadius:10,textAlign:'left',cursor:'pointer',background:active?'rgba(79,142,247,.09)':pct>0?'rgba(255,255,255,.05)':'rgba(255,255,255,.02)',outline:active?'1px solid rgba(79,142,247,.3)':pct>0?'1px solid rgba(255,255,255,.09)':'1px solid var(--b1)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div style={{display:'flex',gap:9,alignItems:'center'}}><span style={{fontSize:17}}>{a.icon}</span><div><div style={{fontSize:13,fontWeight:600}}>{a.n}</div><div style={{fontSize:10.5,color:'var(--t3)',marginTop:1.5}}>{a.hint}</div></div></div>
                <span style={{fontFamily:'var(--ffm)',fontSize:12,fontWeight:700,color:pct>0?'var(--blue)':'var(--t3)',background:pct>0?'rgba(79,142,247,.1)':'rgba(255,255,255,.04)',padding:'2px 9px',borderRadius:6}}>{pct}%</span>
              </button>
              {active&&(
                <div style={{display:'flex',gap:5,padding:'7px 2px 2px',animation:'pop-in .14s ease'}}>
                  {[0,25,50,75,100].map(p=>(
                    <button key={p} onClick={()=>{setAlloc(v=>({...v,[a.id]:p}));H.light()}} className="tap" style={{flex:1,padding:'7px 0',borderRadius:8,cursor:'pointer',background:pct===p?'rgba(79,142,247,.18)':'rgba(255,255,255,.05)',color:pct===p?'var(--blue)':'var(--t2)',fontFamily:'var(--ffm)',fontSize:11,fontWeight:pct===p?700:400,border:'none',transition:'all .12s'}}>{p===0?'âœ•':p+'%'}</button>
                  ))}
                </div>
              )}
            </div>
          );
        })}
      </div>
      <div style={{padding:'10px 18px 14px',flexShrink:0}}>
        <button onClick={execute} className="tap btn-glow" style={{width:'100%',padding:'15px',borderRadius:12,background:'linear-gradient(135deg,#4F8EF7,#9D6EF8)',color:'#fff',fontFamily:'var(--ffd)',fontSize:14.5,fontWeight:700,cursor:'pointer',border:'none',boxShadow:'0 0 18px rgba(79,142,247,.26)'}}>Execute Trade â†’</button>
      </div>
    </div>
  );
}

// â”€â”€ INTRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function IntroScreen({onStart}){
  const [p,setP]=useState(0);
  useEffect(()=>{
    const ts=[setTimeout(()=>setP(1),280),setTimeout(()=>setP(2),640),setTimeout(()=>setP(3),1000)];
    return()=>ts.forEach(clearTimeout);
  },[]);
  const t=(n,d=0)=>({opacity:p>=n?1:0,transform:p>=n?'translateY(0)':'translateY(14px)',transition:`opacity .4s ease ${d}ms,transform .4s cubic-bezier(.34,1.56,.64,1) ${d}ms`});
  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:30,position:'relative',overflow:'hidden'}}>
      <div style={{position:'absolute',inset:0,background:'radial-gradient(ellipse 70% 50% at 50% 38%,rgba(79,142,247,.08) 0%,transparent 70%)',pointerEvents:'none'}}/>
      <div style={{...t(1),width:82,height:82,borderRadius:'50%',background:'radial-gradient(circle at 36% 34%,#4F8EF7,#9D6EF8)',animation:'orb-float 3.2s ease-in-out infinite,orb-glow 2.2s ease-in-out infinite',marginBottom:24,position:'relative',overflow:'hidden',flexShrink:0,boxShadow:'0 0 40px rgba(79,142,247,.3)'}}>
        <div style={{position:'absolute',inset:7,borderRadius:'50%',background:'rgba(0,0,0,.26)',display:'flex',alignItems:'center',justifyContent:'center'}}>
          <div style={{width:'35%',height:'35%',borderRadius:'50%',background:'rgba(255,255,255,.88)',filter:'blur(2.5px)'}}/>
        </div>
      </div>
      <div style={{...t(2,40),textAlign:'center',marginBottom:10}}>
        <div style={{fontFamily:'var(--ffd)',fontSize:42,fontWeight:800,letterSpacing:'-.04em',background:'linear-gradient(135deg,#fff 35%,#9D6EF8)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',lineHeight:1}}>MarketPlay</div>
        <div style={{fontFamily:'var(--ffm)',fontSize:9.5,color:'var(--t3)',letterSpacing:'.2em',marginTop:6}}>FINANCE Â· BUSINESS Â· MARKETS</div>
      </div>
      <div style={{...t(3,80),textAlign:'center',marginBottom:38,color:'var(--t2)',fontSize:14,lineHeight:1.65,maxWidth:255}}>
        Learn money. Understand business.<br/>Read markets like a pro.<br/>No experience needed.
      </div>
      <div style={{...t(3,130),display:'flex',flexDirection:'column',gap:9,width:'100%',maxWidth:300}}>
        <button onClick={()=>{H.medium();onStart('learn')}} className="tap btn-glow" style={{padding:'16px',borderRadius:12,background:'linear-gradient(135deg,#4F8EF7,#9D6EF8)',color:'#fff',fontFamily:'var(--ffd)',fontSize:15,fontWeight:700,cursor:'pointer',border:'none',boxShadow:'0 0 24px rgba(79,142,247,.38)'}}>Start from zero</button>
        <button onClick={()=>{H.medium();onStart('challenge')}} className="tap" style={{padding:'16px',borderRadius:12,border:'1px solid rgba(79,142,247,.22)',background:'rgba(79,142,247,.06)',color:'var(--t1)',fontFamily:'var(--ffd)',fontSize:15,fontWeight:700,cursor:'pointer'}}>âš¡ Challenge me</button>
      </div>
    </div>
  );
}

// â”€â”€ HOME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function HomeScreen({xp,streak,onNavigate,sessionCount}){
  const lv=getLevel(xp);
  const tier=Math.min(5,1+Math.floor(sessionCount/2));
  const TL=['','Beginner','Easy','Medium','Hard','Advanced'];
  const cards=[
    {icon:'ðŸ“š',title:'Finance Foundations',sub:'Lesson Â· 90 sec Â· Why prices move',cta:'Start lesson',screen:'lesson',accent:'#4F8EF7',badge:'+125 XP'},
    {icon:'âš¡',title:'Live Trade Sim',sub:'Unique scenario Â· New every round',cta:'Enter market',screen:'trade',accent:'#9D6EF8',badge:'XP'},
    {icon:'ðŸ§ ',title:'Challenge Mode',sub:`${TL[tier]} questions Â· Finance & Business`,cta:'Start challenge',screen:'challenge',accent:'#0FD98A',badge:'+XP'},
  ];
  return(
    <div style={{flex:1,overflow:'auto',padding:'12px 18px 18px'}}>
      <div style={{marginBottom:16,animation:'screen-in .28s ease'}}>
        <div style={{fontFamily:'var(--ffm)',fontSize:9,color:'var(--t3)',letterSpacing:'.12em'}}>TODAY'S BRIEF</div>
        <h1 style={{fontFamily:'var(--ffd)',fontSize:26,fontWeight:800,letterSpacing:'-.025em',marginTop:3,lineHeight:1.1}}>Sharpen your edge.</h1>
      </div>
      <div style={{background:`linear-gradient(135deg,${lv.color}12,rgba(157,110,248,.07))`,border:`1px solid ${lv.color}24`,borderRadius:13,padding:'13px 15px',marginBottom:10,animation:'screen-in .28s ease .04s both',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <div>
          <div style={{fontFamily:'var(--ffm)',fontSize:8.5,color:lv.color,letterSpacing:'.1em'}}>{lv.name.toUpperCase()}</div>
          <div style={{fontFamily:'var(--ffd)',fontSize:20,fontWeight:800,marginTop:2}}>{lv.name}</div>
          <div style={{fontFamily:'var(--ffm)',fontSize:10,color:'var(--t3)',marginTop:2}}>{xp} XP Â· Questions: {TL[tier]}</div>
        </div>
        <div style={{fontSize:30}}>{lv.icon}</div>
      </div>
      {cards.map((card,ci)=>(
        <div key={card.screen} onClick={()=>{H.light();onNavigate(card.screen)}} className="tap" style={{background:'var(--card)',border:'1px solid var(--b1)',borderRadius:13,padding:'13px 15px',marginBottom:9,cursor:'pointer',animation:`screen-in .28s ease ${.07+ci*.04}s both`}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
            <div style={{display:'flex',gap:10,alignItems:'flex-start'}}>
              <div style={{width:37,height:37,borderRadius:9,background:`${card.accent}18`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:17,flexShrink:0}}>{card.icon}</div>
              <div><div style={{fontFamily:'var(--ffd)',fontSize:15,fontWeight:700}}>{card.title}</div><div style={{fontSize:11,color:'var(--t3)',marginTop:2}}>{card.sub}</div></div>
            </div>
            <div style={{fontFamily:'var(--ffm)',fontSize:8.5,color:card.accent,background:`${card.accent}15`,padding:'2px 7px',borderRadius:5,flexShrink:0}}>{card.badge}</div>
          </div>
          <div style={{marginTop:10,padding:'8px 12px',borderRadius:8,background:`${card.accent}16`,color:card.accent,fontFamily:'var(--ffd)',fontSize:12,fontWeight:700,textAlign:'center'}}>{card.cta} â†’</div>
        </div>
      ))}
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,animation:'screen-in .28s ease .22s both'}}>
        {[{l:'Streak',v:`${streak}ðŸ”¥`,c:'var(--amber)'},{l:'Sessions',v:`${sessionCount}`,c:'var(--blue)'},{l:'Questions',v:`${ALL_Q.length}`,c:'var(--green)'}].map(st=>(
          <div key={st.l} style={{background:'var(--card)',border:'1px solid var(--b1)',borderRadius:10,padding:'10px 7px',textAlign:'center'}}>
            <div style={{fontFamily:'var(--ffd)',fontSize:17,fontWeight:700,color:st.c}}>{st.v}</div>
            <div style={{fontSize:9,color:'var(--t3)',marginTop:2,fontFamily:'var(--ffm)',letterSpacing:'.05em'}}>{st.l.toUpperCase()}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ COMPLETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CompleteScreen({onNavigate}){
  const [b,setB]=useState(false);
  useEffect(()=>{setB(true);const t=setTimeout(()=>setB(false),950);return()=>clearTimeout(t)},[]);
  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:30,position:'relative',overflow:'hidden'}}>
      <Burst active={b} color="#0FD98A"/>
      <div style={{width:66,height:66,borderRadius:'50%',background:'radial-gradient(circle,#0FD98A,#4F8EF7)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,marginBottom:18,animation:'orb-glow 2s ease-in-out infinite',boxShadow:'0 0 28px rgba(15,217,138,.42)'}}>âœ“</div>
      <div style={{fontFamily:'var(--ffd)',fontSize:25,fontWeight:800,letterSpacing:'-.025em',marginBottom:7,textAlign:'center'}}>Lesson Complete</div>
      <div style={{color:'var(--t2)',fontSize:13,textAlign:'center',marginBottom:24,lineHeight:1.55,maxWidth:255}}>You understand why prices move.<br/>That's the foundation everything builds on.</div>
      <div style={{background:'rgba(15,217,138,.09)',border:'1px solid rgba(15,217,138,.22)',borderRadius:11,padding:'10px 20px',fontFamily:'var(--ffm)',fontSize:18,color:'var(--green)',fontWeight:700,marginBottom:24}}>+125 XP</div>
      <div style={{display:'flex',flexDirection:'column',gap:8,width:'100%',maxWidth:295}}>
        <button onClick={()=>{H.medium();onNavigate('trade')}} className="tap btn-glow" style={{padding:'15px',borderRadius:12,background:'linear-gradient(135deg,#4F8EF7,#9D6EF8)',color:'#fff',fontFamily:'var(--ffd)',fontSize:14.5,fontWeight:700,cursor:'pointer',border:'none',boxShadow:'0 0 18px rgba(79,142,247,.3)'}}>Try Live Trade Sim â†’</button>
        <button onClick={()=>{H.light();onNavigate('home')}} className="tap" style={{padding:'15px',borderRadius:12,border:'1px solid var(--b1)',background:'transparent',color:'var(--t2)',fontFamily:'var(--ffd)',fontSize:14.5,fontWeight:700,cursor:'pointer'}}>Back to Home</button>
      </div>
    </div>
  );
}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NavItems=[{id:'home',icon:'âŠž',label:'Home'},{id:'lesson',icon:'ðŸ“š',label:'Learn'},{id:'trade',icon:'âš¡',label:'Trade'},{id:'challenge',icon:'ðŸ§ ',label:'Play'}];

const NavBar=memo(function NavBar({active,onNavigate}){
  return(
    <div className="game-bottom-nav" style={{height:62,borderTop:'1px solid var(--b1)',background:'rgba(5,5,5,.97)',flexShrink:0,alignItems:'center'}}>
      {NavItems.map(it=>(
        <button key={it.id} onClick={()=>{H.light();onNavigate(it.id)}} className="tap" style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:2.5,background:'none',border:'none',padding:'5px 0',opacity:active===it.id?1:.45,cursor:'pointer'}}>
          <span style={{fontSize:18}}>{it.icon}</span>
          <span style={{fontFamily:'var(--ffm)',fontSize:8.5,letterSpacing:'.06em',color:active===it.id?'var(--blue)':'var(--t3)'}}>{it.label.toUpperCase()}</span>
          {active===it.id&&<div style={{width:14,height:1.5,borderRadius:1,background:'var(--blue)',boxShadow:'0 0 5px rgba(79,142,247,.7)'}}/>}
        </button>
      ))}
    </div>
  );
});

function DesktopSidebar({active,onNavigate,xp,streak,xpDelta,sessionCount}){
  const lv=getLevel(xp);
  const nxt=LEVELS[lv.idx+1];
  const pct=nxt?((xp-lv.min)/(nxt.min-lv.min))*100:100;
  return(
    <div className="game-sidebar" style={{width:240,background:'rgba(6,6,10,.98)',borderRight:'1px solid var(--b1)',flexDirection:'column',padding:'28px 16px',gap:8,flexShrink:0}}>
      <div style={{fontFamily:'var(--ffd)',fontSize:22,fontWeight:800,letterSpacing:'-.03em',background:'linear-gradient(135deg,#fff 35%,#9D6EF8)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',marginBottom:24}}>MarketPlay</div>
      <div style={{background:`${lv.color}12`,border:`1px solid ${lv.color}22`,borderRadius:12,padding:'12px 14px',marginBottom:20,position:'relative'}}>
        {xpDelta>0&&<div key={xpDelta+xp} style={{position:'absolute',top:-14,right:8,fontFamily:'var(--ffm)',fontSize:11,color:'var(--green)',fontWeight:700,animation:'xp-rise .9s ease forwards'}}>+{xpDelta}</div>}
        <div style={{fontFamily:'var(--ffm)',fontSize:8,color:lv.color,letterSpacing:'.1em',marginBottom:4}}>{lv.name.toUpperCase()}</div>
        <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}><span style={{fontSize:20}}>{lv.icon}</span><span style={{fontFamily:'var(--ffd)',fontSize:16,fontWeight:800}}>{xp} XP</span></div>
        <div style={{height:3,background:'rgba(255,255,255,.07)',borderRadius:2,overflow:'hidden'}}>
          <div style={{height:'100%',width:`${pct}%`,background:`linear-gradient(90deg,${lv.color},#9D6EF8)`,borderRadius:2,transition:'width 1s cubic-bezier(.34,1.56,.64,1)'}}/>
        </div>
        {streak>0&&<div style={{marginTop:8,display:'flex',alignItems:'center',gap:4}}><span style={{fontSize:12}}>ðŸ”¥</span><span style={{fontFamily:'var(--ffm)',fontSize:10,color:'var(--amber)',fontWeight:700}}>{streak} day streak</span></div>}
      </div>
      {NavItems.map(it=>(
        <button key={it.id} onClick={()=>{H.light();onNavigate(it.id)}} className="tap" style={{display:'flex',alignItems:'center',gap:12,padding:'11px 14px',borderRadius:11,background:active===it.id?'rgba(79,142,247,.12)':'transparent',border:active===it.id?'1px solid rgba(79,142,247,.2)':'1px solid transparent',color:active===it.id?'var(--blue)':'var(--t2)',fontFamily:'var(--ffb)',fontSize:14,fontWeight:active===it.id?700:500,cursor:'pointer',textAlign:'left',width:'100%',transition:'all .18s'}}>
          <span style={{fontSize:17}}>{it.icon}</span>{it.label}
          {active===it.id&&<div style={{marginLeft:'auto',width:6,height:6,borderRadius:'50%',background:'var(--blue)',boxShadow:'0 0 6px rgba(79,142,247,.8)'}}/>}
        </button>
      ))}
      <div style={{marginTop:'auto',padding:'12px 14px',background:'rgba(255,255,255,.02)',border:'1px solid var(--b1)',borderRadius:12}}>
        <div style={{fontFamily:'var(--ffm)',fontSize:8,color:'var(--t3)',letterSpacing:'.1em',marginBottom:10}}>STATS</div>
        {[{l:'Sessions',v:sessionCount},{l:'Streak',v:`${streak}ðŸ”¥`},{l:'Questions',v:ALL_Q.length}].map(s=>(
          <div key={s.l} style={{display:'flex',justifyContent:'space-between',marginBottom:6}}>
            <span style={{fontSize:11,color:'var(--t2)'}}>{s.l}</span>
            <span style={{fontSize:11,fontFamily:'var(--ffm)',color:'var(--t1)',fontWeight:700}}>{s.v}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ ROOT APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App(){
  const [screen,setScreen]=useState('intro');
  const [xp,setXp]=useState(75);
  const [streak]=useState(3);
  const [xpDelta,setXpDelta]=useState(0);
  const [nudge,setNudge]=useState('');
  const [nudgeKey,setNudgeKey]=useState(0);
  const [chatOpen,setChatOpen]=useState(false);
  const [scenario,setScenario]=useState('');
  const [sessionCount,setSessionCount]=useState(0);

  const addXP=useCallback(n=>{setXp(x=>x+n);setXpDelta(n);setTimeout(()=>setXpDelta(0),1100)},[]);
  const onNudge=useCallback(msg=>{setNudge(msg);setNudgeKey(k=>k+1)},[]);
  const go=useCallback(s=>{
    setChatOpen(false);setScreen(s);
    const m={home:cue('start'),lesson:"Let's see what you know.",trade:cue('trade'),challenge:'Speed matters here.'};
    if(m[s]){setNudge(m[s]);setNudgeKey(k=>k+1)};
  },[]);

  // Show API key modal first


  const showNav=['home','lesson','trade','challenge'].includes(screen);
  const showTicker=['home','trade'].includes(screen);

  return(
    <div className="game-shell">
      {showNav&&<DesktopSidebar active={screen} onNavigate={go} xp={xp} streak={streak} xpDelta={xpDelta} sessionCount={sessionCount}/>}
      <div className="game-main" style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden',position:'relative',background:'var(--bg)'}}>
        <div style={{position:'absolute',inset:0,pointerEvents:'none',zIndex:0,background:'radial-gradient(ellipse 80% 42% at 50% 0%,rgba(79,142,247,.06) 0%,transparent 65%)'}}/>
        {showNav&&(
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'11px 17px 8px',borderBottom:'1px solid var(--b1)',flexShrink:0,position:'relative',zIndex:10,background:'rgba(7,7,7,.92)'}}>
            <div style={{fontFamily:'var(--ffd)',fontSize:17,fontWeight:800,letterSpacing:'-.025em',background:'linear-gradient(135deg,#fff 40%,#9D6EF8)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>MarketPlay</div>
            <XPBar xp={xp} streak={streak} delta={xpDelta}/>
          </div>
        )}
        {showTicker&&<Ticker/>}
        <div key={screen} style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden',position:'relative',zIndex:5,animation:'screen-in .24s ease'}}>
          {screen==='intro'&&<IntroScreen onStart={m=>go(m==='challenge'?'challenge':'home')}/>}
          {screen==='home'&&<HomeScreen xp={xp} streak={streak} onNavigate={go} sessionCount={sessionCount}/>}
          {screen==='lesson'&&<LessonScreen onComplete={()=>setScreen('complete')} onXP={addXP} onNudge={onNudge} onScenario={setScenario}/>}
          {screen==='trade'&&<TradeScreen onXP={addXP} onNudge={onNudge} onScenario={setScenario}/>}
          {screen==='challenge'&&<ChallengeScreen onComplete={()=>{setSessionCount(c=>c+1);go('home')}} onXP={addXP} onNudge={onNudge} sessionCount={sessionCount}/>}
          {screen==='complete'&&<CompleteScreen onNavigate={go}/>}
        </div>
        {showNav&&<NavBar active={screen} onNavigate={go}/>}
        {screen!=='intro'&&<AIAssistant open={chatOpen} onToggle={()=>setChatOpen(o=>!o)} nudge={nudge} nudgeKey={nudgeKey} scenario={scenario} hasNav={showNav}/>}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
